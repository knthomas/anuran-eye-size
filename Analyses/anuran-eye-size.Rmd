---
title: "Eye size and investment in anurans"
author: "Kate Thomas"
date: "10/15/2019"
output:
  html_document:
    toc: true
    toc_float: true
---

# Setup

## Install packages

```{r packages, eval = FALSE, include = FALSE}

#Install required packages
install.packages("tidyverse")
install.packages("smatr")
install.packages("plyr")
install.packages("ape")
install.packages("geiger")
install.packages("picante")
install.packages("caper")
install.packages("phytools")
install.packages("phylotools")
install.packages("plotly")
install.packages("knitr")
install.packages("kableExtra")
install.packages("gridExtra")
install.packages("ggimage")
install.packages("grid")
install.packages("gtable")
install.packages("cowplot")

#install ggtree package from Bioconductor
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("ggtree") 
```

## Load libraries
```{r setup, include = FALSE}

# Load package libraries
library(tidyverse)
library(plyr)
library(smatr)
library(picante)
library(ape)
library(geiger)
library(caper)
library(phytools)
library(phylotools)
library(plotly)
library(kableExtra)
library(gridExtra)
library(ggimage)
library(ggtree)
library(grid)
library(gtable)
library(cowplot)
library(knitr)

# Markdown settings
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.height = 4.5, fig.width=8)

```

# Data

## Morphological measurements

We recorded 6 morphological measurements from each frog specimen: snout-vent length, wet mass, corneal diameters (left and right), and transverse eye diameters (left and right). Symmetrical measures (e.g. eye diameters) were averaged for each individual prior to further analysis. 

```{r load-data, include = FALSE}

# Load raw data for measured frog specimens
frogs_morph <- data.frame(read.csv("../Data/frogs_analysis.csv", header=TRUE, na.strings=c("", "NA", " ","<1"))) #load raw data

# Tidy dataset for analysis
frogs.subset <- frogs_morph %>%
  mutate(rootmass = Mass_g^(1/3)) %>% #adds cube root of mass
  mutate(eyemean = rowMeans(frogs_morph[c('ED_right_mm', 'ED_left_mm')], na.rm=TRUE)) %>% #adds mean of L/R eyes
  mutate(cormean = rowMeans(frogs_morph[c('CD_right_mm', 'CD_left_mm')], na.rm=TRUE)) %>%  #adds mean of L/R corneas
  mutate(eyemean = na_if(eyemean, "NaN")) %>% #remove missing values
  mutate(cormean = na_if(cormean, "NaN")) %>% #remove missing values
   select(Order, Suborder, Family, Subfamily, Genus, Species, genus_species, mod_tiplabel, SVL_mm, Mass_g, rootmass, ED_right_mm, ED_left_mm, eyemean, CD_right_mm, CD_left_mm, cormean) #keeps only columns of interest for analyses
```

## Ecological traits

We coded 5 ecological traits for each species from published literature, and then merged this data with our specimen measurements by genus and species. 

```{r trait-data}

#Import ecological trait data
traits <- data.frame(read.csv("../Data/traits_analysis.csv"))

#Change "Unknown" trait categorizations to NA so they will be excluded from statistical comparisons
traits.subset <- traits %>%
  mutate(Adult_habitat = factor(na_if(Adult_habitat, "Unknown"))) %>%
  mutate(Activity_period = factor(na_if(Activity_period, "Unknown"))) %>%
  mutate(Mating_habitat = factor(na_if(Mating_habitat, "Unknown"))) %>%
  mutate(Life_history = factor(na_if(Life_history, "Unknown"))) %>%
  mutate(Larval_habitat = factor(na_if(Larval_habitat, "Unknown"))) %>%
  mutate(Sex_dichromatism = factor(na_if(Sex_dichromatism, "Unknown"))) %>%
  select(genus_species, Adult_habitat, Activity_period, Mating_habitat, 
         Life_history, Larval_habitat, Sex_dichromatism)

# Merge morphology dataset with ecological trait dataset
frogs <- merge(frogs.subset, traits.subset, by="genus_species", 
                   all.x = TRUE, all.y = FALSE)

# Check structure of final dataframe for analyses (numbers and factors in propoer columns)
str(frogs)
```

## Sampling

We sampled all 55 extant anuran families, and morphological sampling for interspecific analysis ranged from n = 1 to n = 7 individuals for each species (based on availability in the collections)

```{r sampling}

#Number of species and individuals sampled 
counts <-ddply(frogs, .(frogs$Family, frogs$Subfamily, frogs$Genus, frogs$Species), nrow)
names(counts) <- c("Family","Subfamily", "Genus","Species","Sampled")

#create scrolling RMarkdown table of sampling
kable(counts[ , c("Family","Genus","Species","Sampled")], caption = "Species and sampling effort for morphological data from museum specimens.") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "500px")
```

## Molecular phylogeny

We downloaded a 309-species phylogeny from Feng et al. (2019) and made a list of all exact species matches and close relatives (substitutions) from our morphological dataset. We then dropped species from the phylogeny that were not present in our dataset and renamed tips to our morphological species (this essentially adds in polytomies at the genus level, but then since we drop unused species it's just a direct replacement of the Feng species with our sampled species in terms of tree topology). 

```{r data-phylogeny, fig.height=50, fig.width=10}

#Import list of species to remove and substitute in Feng tree
changes <- data.frame(read.csv("../Data/phylosubs.csv", header=TRUE))
drops <- as.character(changes$exclude) #create vector of taxa to drop from tree
subs <- changes[ , c("tips_original", "tips_sub")] #create a dataframe with column 1 with all original tip labels, and column 2 with corresponding desired tip labels

#Import full 309 species tree from  Feng et al. (2017) downloaded from Dryad
tree_orig <- read.tree(file = "../Data/Chronogram_309sp.txt") #reads tree

#Drop species not included (as matches or substitutions) in our study
tree_pruned <- drop.tip(phy = tree_orig, tip = drops) 

#Make substitutions of species on tips based on our sampling
tree_pruned$tip.label <- subs[[2]][match(tree_pruned$tip.label, subs[[1]])]

#Check resulting tree
plot.phylo(tree_pruned, 
           type = "phylogram", 
           show.tip.label = TRUE, 
           cex = 0.8, #text size
           no.margin = TRUE, 
           use.edge.length = TRUE,
           edge.width = 1,
           label.offset = .02) 

#rename and check tree
frog.tree <- tree_pruned
is.rooted(frog.tree) #tests whether tree is rooted 
is.binary.tree(frog.tree) #tests whether tree is dichotomous (no polytomies)
frog.tree <- ladderize(frog.tree) #ladderizes tree
plot.phylo(frog.tree) #plots tree
```

# Interspecific allometry

## Standardised major axis fits

### SMAs across species

Standardised major axis fits of scaling relationships for full dataset (not corrected for phylogeny). We include analyses with 1) raw data for each specimen with pseudoreplication within species due to multiple specimens (1-7) per species, and 2) replicate specimens for each species  averaged prior to inclusion in the SMA fit. Because our 4 SMA fits of eye size vs. body size (eye vs. svl, eye vs. mass, cornea vs. svl, cornea vs. mass)  showed extreme residuals with high deviation from normality, we used the option "robust = TRUE" in these 4 SMA fits. This fits a robust SMA using Huber's M estimation, which is less sensitive to outliers. 

#### SMA across full dataset

First we looked at our full dataset including all specimens.

```{r sma-fits-full}

# INTERSPECIES SMA FITS 
# includes pseudoreplication due to multiple specimens (1-7) per species, not phylogenetically corrected

##### mean eye diameter vs. snout vent length #####

# SMA fit of mean eye diameter vs. snout vent length
sma_edsvl <- sma(formula = eyemean ~ SVL_mm, 
               robust = TRUE, #makes estimation robust to outliers
               data = frogs, 
               log = "xy",
               method="SMA", 
               alpha=0.05)
summary(sma_edsvl)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_edsvl, main = "eye ~ SVL")
plot(sma_edsvl, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_edsvl, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

##### mean eye diameter vs. the cube root of mass #####

# SMA fit of mean eye diameter vs. the cube root of mass
sma_edmass <- sma(formula = eyemean ~ rootmass, 
              slope.test = 1, #tests for significant difference from isometry
               robust = TRUE, #makes estimation robust to outliers
               data = frogs, 
               log = "xy",
               method="SMA", 
               alpha=0.05)

summary(sma_edmass)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_edmass, main = "eye ~ mass")
plot(sma_edmass, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_edmass, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot
 
##### cube root of mass vs. SVL #####

# SMA fit of cube root of mass vs. SVL
sma_svlmass <- sma(formula = SVL_mm ~ rootmass,
                   data = frogs, 
                   log = "xy",
                   method = "SMA", 
                   alpha = 0.05)

summary(sma_svlmass)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_svlmass, main = "mass ~ SVL")
plot(sma_svlmass, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_svlmass, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

##### mean cornea diameter vs. mean eye diameter #####

# SMA fit of mean cornea diameter vs. mean eye diameter
sma_edcd <- sma(formula = cormean ~ eyemean, 
                data = frogs,
                log = "xy",
                method = "SMA", 
                alpha = 0.05)

summary(sma_edcd)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_edcd, main = "eye ~ cornea")
plot(sma_edcd, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_edcd, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

##### mean cornea diameter vs. snout vent length #####

# SMA of mean cornea diameter vs. snout vent length
sma_cdsvl <- sma(formula = cormean ~ SVL_mm,
               robust = TRUE, #makes SMA robust to outliers
               data = frogs,
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_cdsvl)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_cdsvl, main = "cornea ~ SVL")
plot(sma_cdsvl, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_cdsvl, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

##### mean cornea diameter vs. cube root of mass #####

# SMA for mean cornea diameter vs. cube root of mass
sma_cdmass <- sma(formula = cormean ~ rootmass,
                robust = TRUE,
                data = frogs, 
                log = "xy",
                method = "SMA", 
                alpha = 0.05)

summary(sma_cdmass)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_cdmass, main = "cornea ~ mass")
plot(sma_cdmass, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_cdmass, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

```

#### SMAs for species averages

Then, to check for the potential effect of confounding developmental allometry with evolutionary allometry and the effect of within-species pseudoreplication, we took species averages for morphological measurements and re-ran our SMA fits to see how this affected parameter estimates.

```{r sma-fits-species-av}

## INTERSPECIES SMA FITS 

# multiple specimens (1-7) per species averaged prior to analysis, not phylogenetically corrected

##### eye diameter vs. snout vent length #####

# Take mean of replicate specimens for each species (and remove specimens with missing data for two traits of interest)
av.edsvl <- frogs %>% 
  mutate_if(is.character, as.factor) %>% 
  filter(!(is.na(eyemean) | is.na(SVL_mm))) %>% 
  group_by(genus_species) %>%
  summarise(eye_av = mean(eyemean), svl_av = mean(SVL_mm))

## Merge data means with other column info
av.edsvl <- merge(av.edsvl, frogs[match(unique(frogs$genus_species), frogs$genus_species), ], by="genus_species", 
                   all.x = TRUE, all.y = FALSE)

# SMA fit of mean eye diameter vs. snout vent length
sma_edsvl_av <- sma(formula = eye_av ~ svl_av, 
               robust = TRUE, #makes estimation robust to outliers
               data = av.edsvl, 
               log = "xy",
               method="SMA", 
               alpha=0.05)
summary(sma_edsvl_av)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_edsvl_av, main = "eye ~ SVL")
plot(sma_edsvl_av, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_edsvl_av, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

##### mean eye diameter vs. the cube root of mass #####

# Take mean of replicate specimens for each species (and remove specimens with missing data for two traits of interest)
av.edmass <- frogs %>% 
  mutate_if(is.character, as.factor) %>% 
  filter(!(is.na(eyemean) | is.na(rootmass))) %>% 
  group_by(genus_species) %>%
  summarise(eye_av = mean(eyemean), rootmass_av = mean(rootmass))

## Merge data means with other column info
av.edmass <- merge(av.edmass, frogs[match(unique(frogs$genus_species), frogs$genus_species), ], by="genus_species", all.x = TRUE, all.y = FALSE)

# SMA fit of mean eye diameter vs. the cube root of mass
sma_edmass_av <- sma(formula = eye_av ~ rootmass_av, 
              slope.test = 1, #tests for significant difference from isometry
               robust = TRUE, #makes estimation robust to outliers
               data = av.edmass, 
               log = "xy",
               method="SMA", 
               alpha=0.05)

summary(sma_edmass_av)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_edmass_av, main = "eye ~ mass")
plot(sma_edmass_av, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_edmass_av, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

##### cube root of mass vs. SVL #####

# Take mean of replicate specimens for each species (and remove specimens with missing data for two traits of interest)
av.svlmass <- frogs %>% 
  mutate_if(is.character, as.factor) %>% 
  filter(!(is.na(SVL_mm) | is.na(rootmass))) %>% 
  group_by(genus_species) %>%
  summarise(svl_av = mean(SVL_mm), rootmass_av = mean(rootmass))

## Merge data means with other column info
av.svlmass <- merge(av.svlmass, frogs[match(unique(frogs$genus_species), frogs$genus_species), ], by="genus_species", all.x = TRUE, all.y = FALSE)

# SMA fit of cube root of mass vs. SVL
sma_svlmass_av <- sma(formula = svl_av ~ rootmass_av,
                   data = av.svlmass, 
                   log = "xy",
                   method = "SMA", 
                   alpha = 0.05)

summary(sma_svlmass_av)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_svlmass_av, main = "mass ~ SVL")
plot(sma_svlmass_av, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_svlmass_av, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

##### mean cornea diameter vs. mean eye diameter #####

# Take mean of replicate specimens for each species (and remove specimens with missing data for two traits of interest)
av.edcd <- frogs %>% 
  filter(!(is.na(cormean)|is.na(eyemean))) %>% 
  mutate_if(is.character, as.factor) %>% 
  #filter(!is.na(eyemean) | !is.na(cormean)) %>% 
  group_by(genus_species) %>%
  summarise(eye_av = mean(eyemean), cornea_av = mean(cormean))

## Merge data means with other column info
av.edcd <- merge(av.edcd, frogs[match(unique(frogs$genus_species), frogs$genus_species), ], by="genus_species", 
                   all.x = TRUE, all.y = FALSE)

# SMA fit of mean cornea diameter vs. mean eye diameter
sma_edcd_av <- sma(formula = cornea_av ~ eye_av, 
                data = av.edcd,
                log = "xy",
                method = "SMA", 
                alpha = 0.05)

summary(sma_edcd_av)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_edcd_av, main = "eye ~ cornea")
plot(sma_edcd_av, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_edcd_av, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

##### mean cornea diameter vs. snout vent length #####

# Take mean of replicate specimens for each species (and remove specimens with missing data for two traits of interest)
av.cdsvl <- frogs %>% 
  mutate_if(is.character, as.factor) %>% 
  filter(!(is.na(cormean) | is.na(SVL_mm))) %>% 
  group_by(genus_species) %>%
  summarise(cornea_av = mean(cormean), svl_av = mean(SVL_mm))

## Merge data means with other column info
av.cdsvl <- merge(av.cdsvl, frogs[match(unique(frogs$genus_species), frogs$genus_species), ], by="genus_species", 
                   all.x = TRUE, all.y = FALSE)

# SMA of mean cornea diameter vs. snout vent length
sma_cdsvl_av <- sma(formula = cornea_av ~ svl_av,
               robust = TRUE, #makes SMA robust to outliers
               data = av.cdsvl,
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_cdsvl_av)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_cdsvl_av, main = "cornea ~ SVL")
plot(sma_cdsvl_av, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_cdsvl_av, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

##### mean cornea diameter vs. cube root of mass #####

# Take mean of replicate specimens for each species (and remove specimens with missing data for two traits of interest)
av.cdmass <- frogs %>% 
  mutate_if(is.character, as.factor) %>% 
  filter(!(is.na(cormean) | is.na(rootmass))) %>% 
  group_by(genus_species) %>%
  summarise(cornea_av = mean(cormean), rootmass_av = mean(rootmass))

## Merge data means with other column info
av.cdmass <- merge(av.cdmass, frogs[match(unique(frogs$genus_species), frogs$genus_species), ], by="genus_species", 
                   all.x = TRUE, all.y = FALSE)


# SMA for mean cornea diameter vs. cube root of mass
sma_cdmass_av <- sma(formula = cornea_av ~ rootmass_av,
                robust = TRUE,
                data = av.cdmass, 
                log = "xy",
                method = "SMA", 
                alpha = 0.05)

summary(sma_cdmass_av)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(sma_cdmass_av, main = "cornea ~ mass")
plot(sma_cdmass_av, which = "residual") #check assumptions of linearity and equal variance at all fitted values
plot(sma_cdmass_av, which = "qq") #check assumption of normally distributed residuals
par(mfrow = c(1,1)) #set plotting window back to one plot

```

Next we made figures of our scaling results with SMA fits (including all specimens), with each species colored by the adult habitat it occupies. 

```{r sma-plots-full}

#make a colorblind-friendly pallette for habitat
col_hab <- c("Aquatic" = "#0072B2",
              "Fossorial" = "#D55E00",
              "Ground-dwelling" = "#E69F00",
              "Scansorial" = "#009E73",
              "Semiaquatic" = "#56B4E9",
              "Subfossorial" = "#CC79A7")

#plot for eye vs SVL
plot_edsvl <- ggplot(frogs, aes(x = SVL_mm, y = eyemean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "eye diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_abline(slope = coef(sma_edsvl)[[2]], intercept = coef(sma_edsvl)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#plot for eye vs cube root of mass
plot_edmass <- ggplot(frogs, aes(x = rootmass, y = eyemean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "eye diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_edmass)[[2]], intercept = coef(sma_edmass)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#plot for mass vs. SVL
plot_svlmass <- ggplot(frogs, aes(x = rootmass, y = SVL_mm, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "snout-vent length (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_svlmass)[[2]], intercept = coef(sma_svlmass)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#plot for cornea vs. eye
plot_edcd <- ggplot(frogs, aes(x = eyemean, y = cormean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "eye diameter (mm)") +
  geom_abline(slope = coef(sma_edcd)[[2]], intercept = coef(sma_edcd)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#plot for cornea vs. SVL
plot_cdsvl <- ggplot(frogs, aes(x = SVL_mm, y = cormean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_abline(slope = coef(sma_cdsvl)[[2]], intercept = coef(sma_cdsvl)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#plot for cornea vs. mass
plot_cdmass <- ggplot(frogs, aes(x = rootmass, y = cormean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_cdmass)[[2]], intercept = coef(sma_cdmass)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#make interactive plots with plotly package (great for exploring data and outliers)
ggplotly(plot_edsvl)
ggplotly(plot_edmass)
ggplotly(plot_svlmass)
ggplotly(plot_edcd)
ggplotly(plot_cdsvl)
ggplotly(plot_cdmass)
```

We also looked at plots for species averages to compare those fits to our full specimen dataset. 

```{r sma-plots-averaged, fig.height=4, fig.width=7}

#make a colorblind-friendly pallette for habitat
col_hab <- c("Aquatic" = "#0072B2",
              "Fossorial" = "#D55E00",
              "Ground-dwelling" = "#E69F00",
              "Scansorial" = "#009E73",
              "Semiaquatic" = "#56B4E9",
              "Subfossorial" = "#CC79A7")
#plot for eye vs SVL
plot_edsvl_av <- ggplot(av.edsvl, aes(x = svl_av, y = eye_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "eye diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_abline(slope = coef(sma_edsvl_av)[[2]], intercept = coef(sma_edsvl_av)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#plot for eye vs cube root of mass
plot_edmass_av <- ggplot(av.edmass, aes(x = rootmass_av, y = eye_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "eye diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_edmass_av)[[2]], intercept = coef(sma_edmass_av)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#plot for mass vs. SVL
plot_svlmass_av <- ggplot(av.svlmass, aes(x = rootmass_av, y = svl_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "snout-vent length (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_svlmass_av)[[2]], intercept = coef(sma_svlmass_av)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#plot for eye vs. cornea
plot_edcd_av <- ggplot(av.edcd, aes(x = eye_av, y = cornea_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "eye diameter (mm)") +
  geom_abline(slope = coef(sma_edcd_av)[[2]], intercept = coef(sma_edcd_av)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#plot for cornea vs. SVL
plot_cdsvl_av <- ggplot(av.cdsvl, aes(x = svl_av, y = cornea_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_abline(slope = coef(sma_cdsvl_av)[[2]], intercept = coef(sma_cdsvl_av)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#plot for cornea vs. mass
plot_cdmass_av <- ggplot(av.cdmass, aes(x = rootmass_av, y = cornea_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_cdmass_av)[[2]], intercept = coef(sma_cdmass_av)[[1]], linetype = "dashed")  #plots SMA fit with dashed line

#make interactive plots with plotly package (great for exploring data and outliers)
ggplotly(plot_edsvl_av)
ggplotly(plot_edmass_av)
ggplotly(plot_svlmass_av)
ggplotly(plot_edcd_av)
ggplotly(plot_cdsvl_av)
ggplotly(plot_cdmass_av)
```

Then we construct a pdf figure from our full dataset and SMA fits for morphological scaling with data points colored by adult habitat. 

```{r supp-smas, fig.height = 8, fig.width = 6}

#smas
fig.a <- ggplot(frogs, aes(x = SVL_mm, y = cormean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat), size = 1.3) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_point(data = av.cdsvl, aes(x = svl_av, y = cornea_av, fill = Adult_habitat), alpha = 1, pch = 21, size = 1) +
  scale_fill_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  geom_abline(slope = coef(sma_cdsvl)[[2]], intercept = coef(sma_cdsvl)[[1]], linetype = "dashed") + #plots SMA fit with dashed line 
  theme(legend.position = "none")

#plot for cornea vs. mass
fig.b <- ggplot(frogs, aes(x = rootmass, y = cormean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat), size = 1.3) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
    geom_point(data = av.cdmass, aes(x = rootmass_av, y = cornea_av, fill = Adult_habitat), alpha = 1, pch = 21, size = 1) +
  scale_fill_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  geom_abline(slope = coef(sma_cdmass)[[2]], intercept = coef(sma_cdmass)[[1]], linetype = "dashed") +  #plots SMA fit with dashed line
  theme(legend.position = "none")

#plot for mass vs. SVL
fig.c <- ggplot(frogs, aes(x = rootmass, y = SVL_mm, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat), size = 1.3) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "snout-vent length (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
    geom_point(data = av.svlmass, aes(x = rootmass_av, y = svl_av, fill = Adult_habitat), alpha = 1, pch = 21, size = 1) +
  scale_fill_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  geom_abline(slope = coef(sma_svlmass)[[2]], intercept = coef(sma_svlmass)[[1]], linetype = "dashed") + #plots SMA fit with dashed line
theme(legend.position = "none")

# extract legend from one figure
leg <- get_legend(plot_edsvl + theme(legend.position = "bottom"))

#use cowplot package to nicely plot the graphs together with a shared common legend.
plots <- plot_grid(fig.a, fig.b, fig.c, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("A", "B", "C"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of columns in grids

#construct full figure with panels and legend
#plot_grid(plots, leg, nrow = 2, rel_heights = c(1, 0.1))
plot_grid(plots, leg, nrow=2, rel_heights = c(1, 0.1), align = 'vh')

#export pdf of figure
pdf("../figure-sma-supp.pdf", width=9, height=3)
plot_grid(plots, leg, nrow=2, rel_heights = c(1, 0.25), align = 'vh')
dev.off()
```

### SMAs by habitat across species 

Because habitat was the main ecological variable that showed big differences in eye investment across states, we also fit SMAs separately for each habitat group to test for differences in eye scaling with body size among species occupying different adult habitats. Using the "smatr" package, we fit SMAs for eye scaling by habitat group and tested whether the slopes were the same across groups. 

Again, we did this across our full specimen dataest first, but then repeated it using species averages to check whether this had an effect on our results. 

```{r smas-habitats-unaveraged}
# SMA scaling by adult habitat groups (full specimen dataset)

#make dataframe without "Unknown" habitat category (as not a true ecological habitat)
frogs.habitat <- frogs %>% 
  select(genus_species, Adult_habitat, eyemean, cormean, SVL_mm, rootmass) %>% 
  filter(Adult_habitat != "Unknown")

# SMA fits of eye diameter vs. cube root of mass by habitat type
sma_habs.mass <- sma(formula = eyemean ~ rootmass * Adult_habitat, 
               data = frogs.habitat, 
               log = "xy",
               method="SMA", 
               alpha=0.05,
               multcomp=TRUE, 
               multcompmethod = "adjusted")

summary(sma_habs.mass) #print results
multcompmatrix(sma_habs.mass) #show pairwise comparisons

# SMA fits of eye diameter vs. SVL by habitat type
sma_habs.svl <- sma(formula = eyemean ~ SVL_mm * Adult_habitat, 
               data = frogs.habitat, 
               log = "xy",
               method="SMA", 
               alpha=0.05,
               multcomp=TRUE, 
               multcompmethod = "adjusted")

summary(sma_habs.svl) #print results
multcompmatrix(sma_habs.svl) #show pairwise comparisons


# SMA fits of corneal diameter vs. eye diameter by habitat type
sma_habs.cor <- sma(formula = cormean ~ eyemean * Adult_habitat, 
               data = frogs.habitat, 
               log = "xy",
               method="SMA", 
               alpha=0.05,
               multcomp=TRUE, 
               multcompmethod = "adjusted")

summary(sma_habs.cor) #show results
multcompmatrix(sma_habs.cor) #show pairwise comparisons

# SMA fits of svl vs. cube root of mass by habitat type
sma_habs.svlmass <- sma(formula = SVL_mm ~ rootmass * Adult_habitat, 
               data = frogs.habitat,
               log = "xy",
               method="SMA", 
               alpha=0.05,
               multcomp=TRUE, 
               multcompmethod = "adjusted")

summary(sma_habs.svlmass) #show results
multcompmatrix(sma_habs.svlmass) #show pairwise comparisons
```

Here, we repeat this analysis using species averages. 

```{r smas-habitats-averaged}

# SMA scaling by adult habitat groups with species averages (no pseudoreplication)

# SMA fits of eye diameter vs. cube root of mass by habitat type
av.edmass.hab <- av.edmass %>% 
  filter(Adult_habitat != "Unknown")

sma_habs.mass_av <- sma(formula = eye_av ~ rootmass_av * Adult_habitat, 
               data = av.edmass.hab, 
               log = "xy",
               method="SMA", 
               alpha=0.05,
               multcomp=TRUE, 
               multcompmethod = "adjusted")

summary(sma_habs.mass_av)

# SMA fits of eye diameter vs. SVL by habitat type
av.edsvl.hab <- av.edsvl %>% 
  filter(Adult_habitat != "Unknown")

sma_habs.svl_av <- sma(formula = eye_av ~ svl_av * Adult_habitat, 
               data = av.edsvl.hab, 
               log = "xy",
               method="SMA", 
               alpha=0.05,
               multcomp=TRUE, 
               multcompmethod = "adjusted")

summary(sma_habs.svl_av)

# SMA fits of corneal diameter vs. eye diameter by habitat type
av.edcd.hab <- av.edcd %>% 
  filter(Adult_habitat != "Unknown")

sma_habs.cor_av <- sma(formula = cornea_av ~ eye_av * Adult_habitat, 
               data = av.edcd.hab, 
               log = "xy",
               method="SMA", 
               alpha=0.05,
               multcomp=TRUE, 
               multcompmethod = "adjusted")

summary(sma_habs.cor_av)

# SMA fits of svl vs. cube root of mass by habitat type
av.svlmass.hab <- av.svlmass %>% 
  filter(Adult_habitat != "Unknown")

sma_habs.svlmass_av <- sma(formula = svl_av ~ rootmass_av * Adult_habitat, 
               data = av.svlmass.hab,
               log = "xy",
               method="SMA", 
               alpha=0.05,
               multcomp=TRUE, 
               multcompmethod = "adjusted")

summary(sma_habs.svlmass_av)
```

Then we plotted our data and scaling fits by habitat. 

Here, for raw data for every specimen

```{r plot-sma-habitats}

#make a colorblind-friendly pallette for habitat
col_hab <- c("Aquatic" = "#0072B2",
              "Fossorial" = "#D55E00",
              "Ground-dwelling" = "#E69F00",
              "Scansorial" = "#009E73",
              "Semiaquatic" = "#56B4E9",
              "Subfossorial" = "#CC79A7")

#plot for eye vs SVL SMA fits by habitat group
plot_sma_habs.svl <- ggplot(frogs.habitat, aes(x = SVL_mm, y = eyemean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "mean eye diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_abline(slope = coef(sma_habs.svl)[[2]], intercept = coef(sma_habs.svl)[[1]], linetype = "dashed", col = col_hab)
  
ggplotly(plot_sma_habs.svl)

#plot for eye vs cube root of mass SMA fits by habitat group
plot_sma_habs.mass <- ggplot(frogs.habitat, aes(x = rootmass, y = eyemean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "mean eye diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_habs.mass)[[2]], intercept = coef(sma_habs.mass)[[1]], linetype = "dashed", col = col_hab)
  
ggplotly(plot_sma_habs.mass)

#plot for cornea vs eye SMA fits by habitat group
plot_sma_habs.cor <- ggplot(frogs.habitat, aes(x = eyemean, y = cormean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "mean cornea diameter (mm)") +
  scale_x_log10(name = "mean eye diameter (mm)") +
  geom_abline(slope = coef(sma_habs.cor)[[2]], intercept = coef(sma_habs.cor)[[1]], linetype = "dashed", col = col_hab)
  
ggplotly(plot_sma_habs.cor)

#plot for SVL vs rootmass SMA fits by habitat group
plot_sma_habs.svlmass <- ggplot(frogs.habitat, aes(x = rootmass, y = SVL_mm, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "snout-vent length (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_habs.svlmass)[[2]], intercept = coef(sma_habs.svlmass)[[1]], linetype = "dashed", col = col_hab)

ggplotly(plot_sma_habs.svlmass)
```

And here, for species averages (no pseudoreplication)

```{r plot-sma-habitats-averaged}

#plot for eye vs SVL SMA fits by habitat group
plot_sma_habs.svl_av <- ggplot(av.edsvl.hab, aes(x = svl_av, y = eye_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "mean eye diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_abline(slope = coef(sma_habs.svl_av)[[2]], intercept = coef(sma_habs.svl_av)[[1]], linetype = "dashed", col = col_hab)
  
ggplotly(plot_sma_habs.svl_av)

#plot for eye vs cube root of mass SMA fits by habitat group
plot_sma_habs.mass_av <- ggplot(av.edmass.hab, aes(x = rootmass_av, y = eye_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "mean eye diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_habs.mass_av)[[2]], intercept = coef(sma_habs.mass_av)[[1]], linetype = "dashed", col = col_hab)
  
ggplotly(plot_sma_habs.mass_av)

#plot for cornea vs eye SMA fits by habitat group
plot_sma_habs.cor_av <- ggplot(av.edcd.hab, aes(x = eye_av, y = cornea_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "mean cornea diameter (mm)") +
  scale_x_log10(name = "mean eye diameter (mm)") +
  geom_abline(slope = coef(sma_habs.cor_av)[[2]], intercept = coef(sma_habs.cor_av)[[1]], linetype = "dashed", col = col_hab)
  
ggplotly(plot_sma_habs.cor_av)

#plot for SVL vs rootmass SMA fits by habitat group
plot_sma_habs.svlmass_av <- ggplot(av.svlmass.hab, aes(x = rootmass_av, y = svl_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab, name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "snout-vent length (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_habs.svlmass_av)[[2]], intercept = coef(sma_habs.svlmass_av)[[1]], linetype = "dashed", col = col_hab)

ggplotly(plot_sma_habs.svlmass_av)

```

Finally, we make a pdf figure showing our full specimen dataset and the associated SMA fits by habitat. 

```{r sma-habs-figure, fig.height=8, fig.width=8, fig.cap = "SMA fits for eye scaling by habitat type. SMA tests indicate that the slopes of these scaling relationships are unequal."}

#make panels
fig.a <-  plot_sma_habs.mass +
  theme(legend.position = "none")

fig.b <- plot_sma_habs.svl +
  theme(legend.position = "none")

fig.c <- plot_sma_habs.cor +
  theme(legend.position = "none")

fig.d <- plot_sma_habs.svlmass +
  theme(legend.position = "none")

#use cowplot package to nicely plot the graphs together 
plots <- plot_grid(fig.a, fig.b, fig.c, fig.d, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("A", "B", "C", "D"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           ncol = 2) #number of columns in grids

# extract legend from one figure
leg <- get_legend(plot_sma_habs.svl_av + theme(legend.position = "bottom"))

#export pdf of figure
pdf("../figure-habsma.pdf", width=8, height=8)
plot_grid(plots, leg, nrow = 2, rel_heights = c(1, 0.2))
dev.off()
```

***

# Phylogenetic generalized least-squares fits

## PGLS of eye diameter vs. cube root of mass

We fit a PGLS model using the modified Feng et al. (2017) phylogeny and our averaged species data for morphological traits. We also fit an SMA to the same dataset for comparison. 

```{r pgls-fit-edmass}

#fit PGLS model for eye size vs. SVL using 'caper' package

#remove rows from averaged dataframe not in phylogeny
av.edmass.phy <- av.edmass %>%
  drop_na(mod_tiplabel)

#check that names match in dataframe and tree
name.check(phy = tree_pruned, data = av.edmass.phy, data.names = av.edmass$mod_tiplabel)
  
#use caper function to combine phylogeny and data into one object (this function also matches species names in tree and dataset)
edmass.comp <- comparative.data(phy = tree_pruned, data = av.edmass.phy, 
                            names.col = mod_tiplabel, vcv = TRUE, 
                            na.omit = FALSE, warn.dropped = TRUE)

#check for dropped tips or dropped species
edmass.comp$dropped$tips #phylogeny
edmass.comp$dropped$unmatched.rows #dataset

#run PGLS model for eye diameter vs. cube root of mass using the Maximum Liklihood estimate of lambda
pgls_edmass <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = av.edmass.phy)
abline(pgls_edmass)

#likelihood profile for lambda from the PGLS model
lambda.edmass <- pgls.profile(pgls_edmass, "lambda")

#SMA fit for eye size on identical dataset
sma_edmass.phy <- sma(formula = eye_av ~ rootmass_av,
               robust = TRUE,
               data = av.edmass.phy, 
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

#view model output
summary(sma_edmass.phy)
```

Then we plotted the likelihood profile for lambda in our PGLS. 

```{r plot-lambda-edmass, fig.cap = "Likelihood plot for Pagel's lambda from the PGLS model of eye diameter vs. the cuberoot of mass. Solid red line indicates estimate for lambda and broken red lines indcaite the 95% confidence interval. "}

plot(lambda.edmass)

```

For the PGLS of mean eye diameter vs. the cube root of mass, Pagel's lambda was `r pgls.confint(pgls_edmass, "lambda")$opt` with 95% confidence intervals of `r pgls.confint(pgls_edmass, "lambda")$ci.val`, indicating that there is high phylogenetic signal in the residuals of our PGLS model fit (which is our measure of relative eye investment).

Next we looked at diagnostic plots for our model to check that model assumptions were met. 

```{r plot-diagonstics-edmass, fig.cap = "Model diagnostic plots for PGLS of frog eye diameter vs. the cube root of mass. The plots show some large residuals, which can result in a poor model fit."}

par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass, main = "PGLS model for mean eye diameter vs. svl")
par(mfrow = c(1, 1))

```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residual exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outliers eliminated. 

```{r pgls-eyemass-nooutliers1}

# refit pgls after removing extreme outlier observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edmass <- residuals(pgls_edmass, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edmass <- phyres.edmass/sqrt(var(phyres.edmass))[1] 

#match species names with standardized residuals
rownames(stphyres.edmass)<-rownames(pgls_edmass$residuals) #matches the residuals up with the species names

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edmass)[(abs(stphyres.edmass)>3)]
 
#remove these two species from data/tree
edmass.comp.nooutliers <- edmass.comp[-which(abs(stphyres.edmass)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edmass_nooutliers <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp.nooutliers, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass_nooutliers)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = edmass.comp.nooutliers$data)
abline(pgls_edmass_nooutliers)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass_nooutliers, main = "PGLS model for eye v root mass (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edmass_nooutliers , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residual exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outliers eliminated.

```{r pgls-eyemass-nooutliers2}

# refit pgls after removing extreme outlier observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edmass2 <- residuals(pgls_edmass_nooutliers, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edmass2 <- phyres.edmass2/sqrt(var(phyres.edmass2))[1] 

#match species names with standardized residuals
rownames(stphyres.edmass2)<-rownames(pgls_edmass_nooutliers$residuals)

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edmass2)[(abs(stphyres.edmass2)>3)]
 
#remove these two species from data/tree
edmass.comp.nooutliers2 <- edmass.comp.nooutliers[-which(abs(stphyres.edmass2)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edmass_nooutliers2 <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp.nooutliers2, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass_nooutliers2)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = edmass.comp.nooutliers2$data)
abline(pgls_edmass_nooutliers2)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass_nooutliers2, main = "PGLS model for eye v root mass (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edmass_nooutliers2 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residual exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outliers eliminated.

```{r pgls-eyemass-nooutliers3}

# refit pgls after removing extreme outlier observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edmass3 <- residuals(pgls_edmass_nooutliers2, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edmass3 <- phyres.edmass3/sqrt(var(phyres.edmass3))[1] 

#match species names with standardized residuals
rownames(stphyres.edmass3)<-rownames(pgls_edmass_nooutliers2$residuals)

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edmass3)[(abs(stphyres.edmass3)>3)]
 
#remove these two species from data/tree
edmass.comp.nooutliers3 <- edmass.comp.nooutliers2[-which(abs(stphyres.edmass3)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edmass_nooutliers3 <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp.nooutliers3, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass_nooutliers3)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = edmass.comp.nooutliers3$data)
abline(pgls_edmass_nooutliers3)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass_nooutliers3, main = "PGLS model for eye v root mass (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edmass_nooutliers3 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residual exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outliers eliminated.

```{r pgls-eyemass-nooutliers4}

# refit pgls after removing extreme outlier observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edmass4 <- residuals(pgls_edmass_nooutliers3, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edmass4 <- phyres.edmass4/sqrt(var(phyres.edmass4))[1] 

#match species names with standardized residuals
rownames(stphyres.edmass4)<-rownames(pgls_edmass_nooutliers3$residuals)

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edmass4)[(abs(stphyres.edmass4)>3)]
 
#remove these two species from data/tree
edmass.comp.nooutliers4 <- edmass.comp.nooutliers3[-which(abs(stphyres.edmass4)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edmass_nooutliers4 <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp.nooutliers4, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass_nooutliers4)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = edmass.comp.nooutliers4$data)
abline(pgls_edmass_nooutliers4)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass_nooutliers4, main = "PGLS model for eye v root mass (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edmass_nooutliers4 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residual exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outliers eliminated.

```{r pgls-eyemass-nooutliers5}

# refit pgls after removing extreme outlier observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edmass5 <- residuals(pgls_edmass_nooutliers4, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edmass5 <- phyres.edmass5/sqrt(var(phyres.edmass5))[1] 

#match species names with standardized residuals
rownames(stphyres.edmass5)<-rownames(pgls_edmass_nooutliers4$residuals)

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edmass5)[(abs(stphyres.edmass5)>3)]
 
#remove these two species from data/tree
edmass.comp.nooutliers5 <- edmass.comp.nooutliers4[-which(abs(stphyres.edmass5)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edmass_nooutliers5 <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp.nooutliers5, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass_nooutliers5)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = edmass.comp.nooutliers5$data)
abline(pgls_edmass_nooutliers5)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass_nooutliers5, main = "PGLS model for eye v root mass (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edmass_nooutliers5 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residual exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outliers eliminated.

```{r pgls-eyemass-nooutliers6}

# refit pgls after removing extreme outlier observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edmass6 <- residuals(pgls_edmass_nooutliers5, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edmass6 <- phyres.edmass6/sqrt(var(phyres.edmass6))[1] 

#match species names with standardized residuals
rownames(stphyres.edmass6)<-rownames(pgls_edmass_nooutliers5$residuals)

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edmass6)[(abs(stphyres.edmass6)>3)]
 
#remove these two species from data/tree
edmass.comp.nooutliers6 <- edmass.comp.nooutliers5[-which(abs(stphyres.edmass6)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edmass_nooutliers6 <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp.nooutliers6, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass_nooutliers6)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = edmass.comp.nooutliers6$data)
abline(pgls_edmass_nooutliers6)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass_nooutliers6, main = "PGLS model for eye v root mass (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edmass_nooutliers6 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residual exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outliers eliminated.

```{r pgls-eyemass-nooutliers7}

# refit pgls after removing extreme outlier observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edmass7 <- residuals(pgls_edmass_nooutliers6, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edmass7 <- phyres.edmass7/sqrt(var(phyres.edmass7))[1] 

#match species names with standardized residuals
rownames(stphyres.edmass7)<-rownames(pgls_edmass_nooutliers6$residuals)

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edmass7)[(abs(stphyres.edmass7)>3)]
 
#remove these two species from data/tree
edmass.comp.nooutliers7 <- edmass.comp.nooutliers6[-which(abs(stphyres.edmass7)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edmass_nooutliers7 <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp.nooutliers7, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass_nooutliers7)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = edmass.comp.nooutliers7$data)
abline(pgls_edmass_nooutliers7)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass_nooutliers7, main = "PGLS model for eye v root mass (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edmass_nooutliers7 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residual exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outliers eliminated.

```{r pgls-eyemass-nooutliers8}

# refit pgls after removing extreme outlier observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edmass8 <- residuals(pgls_edmass_nooutliers7, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edmass8 <- phyres.edmass8/sqrt(var(phyres.edmass8))[1] 

#match species names with standardized residuals
rownames(stphyres.edmass8)<-rownames(pgls_edmass_nooutliers7$residuals)

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edmass8)[(abs(stphyres.edmass8)>3)]
 
#remove these two species from data/tree
edmass.comp.nooutliers8 <- edmass.comp.nooutliers7[-which(abs(stphyres.edmass8)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edmass_nooutliers8 <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp.nooutliers8, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass_nooutliers8)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = edmass.comp.nooutliers8$data)
abline(pgls_edmass_nooutliers8)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass_nooutliers8, main = "PGLS model for eye v root mass (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edmass_nooutliers8 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residual exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outliers eliminated.

```{r pgls-eyemass-nooutliers9}

# refit pgls after removing extreme outlier observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edmass9 <- residuals(pgls_edmass_nooutliers8, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edmass9 <- phyres.edmass9/sqrt(var(phyres.edmass9))[1] 

#match species names with standardized residuals
rownames(stphyres.edmass9)<-rownames(pgls_edmass_nooutliers8$residuals)

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edmass9)[(abs(stphyres.edmass9)>3)]
 
#remove these two species from data/tree
edmass.comp.nooutliers9 <- edmass.comp.nooutliers8[-which(abs(stphyres.edmass9)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edmass_nooutliers9 <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp.nooutliers9, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass_nooutliers9)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = edmass.comp.nooutliers9$data)
abline(pgls_edmass_nooutliers9)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass_nooutliers9, main = "PGLS model for eye v root mass (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edmass_nooutliers9 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residual exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outliers eliminated.

```{r pgls-eyemass-nooutliers10}

# refit pgls after removing extreme outlier observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edmass10 <- residuals(pgls_edmass_nooutliers9, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edmass10 <- phyres.edmass10/sqrt(var(phyres.edmass10))[1] 

#match species names with standardized residuals
rownames(stphyres.edmass10)<-rownames(pgls_edmass_nooutliers9$residuals)

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edmass10)[(abs(stphyres.edmass10)>3)]
 
#remove these two species from data/tree
edmass.comp.nooutliers10 <- edmass.comp.nooutliers9[-which(abs(stphyres.edmass10)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edmass_nooutliers10 <- pgls(log10(eye_av) ~ log10(rootmass_av), 
               data = edmass.comp.nooutliers10, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edmass_nooutliers10)

#quick plot of pgls
plot(log10(eye_av) ~ log10(rootmass_av), data = edmass.comp.nooutliers10$data)
abline(pgls_edmass_nooutliers10)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edmass_nooutliers10, main = "PGLS model for eye v root mass (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edmass_nooutliers10 , "lambda"))
```

As iterative removal of phylogenetic outliers has no major effect on model parameter estimates, we include all species in our PGLS of eye diameter vs. the cube root of mass. 
## PGLS of eye diameter vs. snout-vent length 

We fit a PGLS model using the modified Feng et al. (2017) phylogeny and our averaged species data for morphological traits. We also fit an SMA to the same dataset for comparison. 

```{r pgls-fit-edsvl}

#fit PGLS model for eye size vs. SVL using 'caper' package

#remove rows from averaged dataframe not in phylogeny
av.edsvl.phy <- av.edsvl %>%
  drop_na(mod_tiplabel)

#check that names match in dataframe and tree
name.check(phy = tree_pruned, data = av.edsvl.phy, data.names = av.edsvl$mod_tiplabel)
  
#use caper function to combine phylogeny and data into one object (this function also matches species names in tree and dataset)
edsvl.comp <- comparative.data(phy = tree_pruned, data = av.edsvl.phy, 
                            names.col = mod_tiplabel, vcv = TRUE, 
                            na.omit = FALSE, warn.dropped = TRUE)

#check for dropped tips or dropped species
edsvl.comp$dropped$tips #phylogeny
edsvl.comp$dropped$unmatched.rows #dataset

#run PGLS model for eye diameter vs. SVL using the Maximum Liklihood estimate of lambda
pgls_edsvl <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl)

#likelihood profile for lambda from the PGLS model
lambda.edsvl <- pgls.profile(pgls_edsvl, "lambda")

#SMA fit for eye size on identical dataset
sma_edsvl.phy <- sma(formula = eye_av ~ svl_av,
               robust = TRUE,
               data = av.edsvl.phy, 
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

#view model output
summary(sma_edsvl.phy)
```

We plotted the likelihood for lambda in our PGLS. 

```{r plot-lambda-edsvl, fig.cap = "Likelihood plot for Pagel's lambda from the PGLS model of eye diameter vs. snout-vent length. Solid red line indicates estimate for lambda and broken red lines indcaite the 95% confidence interval. "}

plot(lambda.edsvl)

```

For the PGLS of mean eye diameter vs. snout-vent length, Pagel's lambda was `r pgls.confint(pgls_edsvl, "lambda")$opt` with 95% confidence intervals of `r pgls.confint(pgls_edsvl, "lambda")$ci.val`, indicating that there is high phylogenetic signal in the residuals of our PGLS model fit (which is our measure of relative eye investment).

Next we looked at diagnostic plots for our model. 

```{r plot-diagonstics-edsvl, fig.cap = "Model diagnostic plots for PGLS of frog eye diameter vs. snout-vent length. The plots show some large residuals, which can result in a poor model fit."}

par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl, main = "PGLS model for mean eye diameter vs. svl")
par(mfrow = c(1, 1))

```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-eyesvl-nooutliers1}

# refit pgls after removing extreme outliers observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edsvl <- residuals(pgls_edsvl, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edsvl <- phyres.edsvl/sqrt(var(phyres.edsvl))[1] 

#match species names with standardized residuals
rownames(stphyres.edsvl)<-rownames(pgls_edsvl$residuals) #matches the residuals up with the species names

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edsvl)[(abs(stphyres.edsvl)>3)]
 
#remove these two species from data/tree
edsvl.comp.nooutliers <- edsvl.comp[-which(abs(stphyres.edsvl)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edsvl_nooutliers <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp.nooutliers, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl_nooutliers)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl_nooutliers)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl_nooutliers, main = "PGLS model for eye v svl (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edsvl_nooutliers , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-eyesvl-nooutliers2}

# refit pgls after removing the new outlier in the second run. 

#extract the phylogenetic residuals from the original model
phyres.edsvl2 <- residuals(pgls_edsvl_nooutliers, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edsvl2 <- phyres.edsvl2/sqrt(var(phyres.edsvl2))[1] 

#match species names with standardized residuals
rownames(stphyres.edsvl2)<-rownames(pgls_edsvl_nooutliers$residuals) #matches the residuals up with the species names

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edsvl2)[(abs(stphyres.edsvl2)>3)]
 
#remove this species from data/tree
edsvl.comp.nooutliers2 <- edsvl.comp.nooutliers[-which(abs(stphyres.edsvl2)>3), ]

#re-run pgls analysis (without the outliers)
pgls_edsvl_nooutliers2 <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp.nooutliers2, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl_nooutliers2)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl_nooutliers2)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl_nooutliers2, main = "PGLS model for eye v svl (no outliers 2)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edsvl_nooutliers2 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-eyesvl-nooutliers3}

# refit pgls after removing the new outlier in the second run. 

#extract the phylogenetic residuals from the original model
phyres.edsvl3 <- residuals(pgls_edsvl_nooutliers2, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edsvl3 <- phyres.edsvl3/sqrt(var(phyres.edsvl3))[1] 

#match species names with standardized residuals
rownames(stphyres.edsvl3)<-rownames(pgls_edsvl_nooutliers2$residuals) #matches the residuals up with the species names

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edsvl3)[(abs(stphyres.edsvl3)>3)]
 
#remove this species from data/tree
edsvl.comp.nooutliers3 <- edsvl.comp.nooutliers2[-which(abs(stphyres.edsvl3)>3), ]

#re-run pgls analysis (without the outliers)
pgls_edsvl_nooutliers3 <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp.nooutliers3, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl_nooutliers3)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl_nooutliers3)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl_nooutliers3, main = "PGLS model for eye v svl (no outliers 3)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edsvl_nooutliers3 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-eyesvl-nooutliers4}

# refit pgls after removing the new outlier in the second run. 

#extract the phylogenetic residuals from the original model
phyres.edsvl4 <- residuals(pgls_edsvl_nooutliers3, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edsvl4 <- phyres.edsvl4/sqrt(var(phyres.edsvl4))[1] 

#match species names with standardized residuals
rownames(stphyres.edsvl4)<-rownames(pgls_edsvl_nooutliers3$residuals) #matches the residuals up with the species names

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edsvl4)[(abs(stphyres.edsvl4)>3)]
 
#remove these two species from data/tree
edsvl.comp.nooutliers4 <- edsvl.comp.nooutliers3[-which(abs(stphyres.edsvl4)>3), ]

#re-run pgls analysis (without the outliers)
pgls_edsvl_nooutliers4 <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp.nooutliers4, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl_nooutliers4)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl_nooutliers4)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl_nooutliers4, main = "PGLS model for eye v svl (no outliers 4)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edsvl_nooutliers4 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-eyesvl-nooutliers5}

# refit pgls after removing the new outlier in the second run. 

#extract the phylogenetic residuals from the original model
phyres.edsvl5 <- residuals(pgls_edsvl_nooutliers4, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edsvl5 <- phyres.edsvl5/sqrt(var(phyres.edsvl5))[1] 

#match species names with standardized residuals
rownames(stphyres.edsvl5)<-rownames(pgls_edsvl_nooutliers4$residuals) 

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edsvl5)[(abs(stphyres.edsvl5)>3)]
 
#remove these two species from data/tree
edsvl.comp.nooutliers5 <- edsvl.comp.nooutliers4[-which(abs(stphyres.edsvl5)>3), ]

#re-run pgls analysis (without the outliers)
pgls_edsvl_nooutliers5 <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp.nooutliers5, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl_nooutliers5)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl_nooutliers5)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl_nooutliers5, main = "PGLS model for eye v svl (no outliers 5)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edsvl_nooutliers5 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-eyesvl-nooutliers6}

# refit pgls after removing the new outlier in the second run. 

#extract the phylogenetic residuals from the original model
phyres.edsvl6 <- residuals(pgls_edsvl_nooutliers5, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edsvl6 <- phyres.edsvl6/sqrt(var(phyres.edsvl6))[1] 

#match species names with standardized residuals
rownames(stphyres.edsvl6)<-rownames(pgls_edsvl_nooutliers5$residuals) 

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edsvl6)[(abs(stphyres.edsvl6)>3)]
 
#remove these two species from data/tree
edsvl.comp.nooutliers6 <- edsvl.comp.nooutliers5[-which(abs(stphyres.edsvl6)>3), ]

#re-run pgls analysis (without the outliers)
pgls_edsvl_nooutliers6 <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp.nooutliers6, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl_nooutliers6)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl_nooutliers6)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl_nooutliers6, main = "PGLS model for eye v svl (no outliers 5)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edsvl_nooutliers6 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-eyesvl-nooutliers7}

# refit pgls after removing the new outlier(s) form previous run

#extract the phylogenetic residuals from the original model
phyres.edsvl7 <- residuals(pgls_edsvl_nooutliers6, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edsvl7 <- phyres.edsvl7/sqrt(var(phyres.edsvl7))[1] 

#match species names with standardized residuals
rownames(stphyres.edsvl7)<-rownames(pgls_edsvl_nooutliers6$residuals) 

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edsvl7)[(abs(stphyres.edsvl7)>3)]
 
#remove these two species from data/tree
edsvl.comp.nooutliers7 <- edsvl.comp.nooutliers6[-which(abs(stphyres.edsvl7)>3), ]

#re-run pgls analysis (without the outliers)
pgls_edsvl_nooutliers7 <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp.nooutliers7, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl_nooutliers7)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl_nooutliers7)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl_nooutliers7, main = "PGLS model for eye v svl (no outliers 7)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edsvl_nooutliers7 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-eyesvl-nooutliers8}

# refit pgls after removing the new outlier(s) form previous run

#extract the phylogenetic residuals from the original model
phyres.edsvl8 <- residuals(pgls_edsvl_nooutliers7, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edsvl8 <- phyres.edsvl8/sqrt(var(phyres.edsvl8))[1] 

#match species names with standardized residuals
rownames(stphyres.edsvl8)<-rownames(pgls_edsvl_nooutliers7$residuals) 

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edsvl8)[(abs(stphyres.edsvl8)>3)]
 
#remove these two species from data/tree
edsvl.comp.nooutliers8 <- edsvl.comp.nooutliers7[-which(abs(stphyres.edsvl8)>3), ]

#re-run pgls analysis (without the outliers)
pgls_edsvl_nooutliers8 <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp.nooutliers8, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl_nooutliers8)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl_nooutliers8)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl_nooutliers8, main = "PGLS model for eye v svl (no outliers 7)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edsvl_nooutliers8 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-eyesvl-nooutliers9}

# refit pgls after removing the new outlier(s) form previous run

#extract the phylogenetic residuals from the original model
phyres.edsvl9 <- residuals(pgls_edsvl_nooutliers8, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edsvl9 <- phyres.edsvl9/sqrt(var(phyres.edsvl9))[1] 

#match species names with standardized residuals
rownames(stphyres.edsvl9)<-rownames(pgls_edsvl_nooutliers8$residuals) 

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edsvl9)[(abs(stphyres.edsvl9)>3)]
 
#remove these two species from data/tree
edsvl.comp.nooutliers9 <- edsvl.comp.nooutliers8[-which(abs(stphyres.edsvl9)>3), ]

#re-run pgls analysis (without the outliers)
pgls_edsvl_nooutliers9 <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp.nooutliers9, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl_nooutliers9)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl_nooutliers9)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl_nooutliers9, main = "PGLS model for eye v svl (no outliers 9)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edsvl_nooutliers9 , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-eyesvl-nooutliers10}

# refit pgls after removing the new outlier(s) form previous run

#extract the phylogenetic residuals from the original model
phyres.edsvl10 <- residuals(pgls_edsvl_nooutliers9, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edsvl10 <- phyres.edsvl10/sqrt(var(phyres.edsvl10))[1] 

#match species names with standardized residuals
rownames(stphyres.edsvl10)<-rownames(pgls_edsvl_nooutliers9$residuals) 

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edsvl10)[(abs(stphyres.edsvl10)>3)]
 
#remove these two species from data/tree
edsvl.comp.nooutliers10 <- edsvl.comp.nooutliers9[-which(abs(stphyres.edsvl10)>3), ]

#re-run pgls analysis (without the outliers)
pgls_edsvl_nooutliers10 <- pgls(log10(eye_av) ~ log10(svl_av), 
               data = edsvl.comp.nooutliers10, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edsvl_nooutliers10)

#quick plot of pgls
plot(log10(eye_av) ~ log10(svl_av), data = av.edsvl.phy)
abline(pgls_edsvl_nooutliers10)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edsvl_nooutliers10, main = "PGLS model for eye v svl (no outliers 10)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edsvl_nooutliers10 , "lambda"))
```

Again, as iterative removal of phylogenetic outliers did not qualitatively change our results, we use the full dataset for our PGLS of eye diameter vs. snout-vent length. 

## PGLS of corneal diameter vs. eye diameter

We fit a PGLS model using the modified Feng et al. (2017) phylogeny and our averaged species data for morphological traits. We also fit an SMA to the same dataset for comparison. 

```{r pgls-fit-edcd}

#fit PGLS model for corneal diameter vs. eye diameter using 'caper' package

#remove rows from averaged dataframe not in phylogeny
av.edcd.phy <- av.edcd %>%
  drop_na(mod_tiplabel)

#check that names match in dataframe and tree
name.check(phy = tree_pruned, data = av.edcd.phy, data.names = av.edcd$mod_tiplabel)
  
#use caper function to combine phylogeny and data into one object (this function also matches species names in tree and dataset)
edcd.comp <- comparative.data(phy = tree_pruned, data = av.edcd.phy, 
                            names.col = mod_tiplabel, vcv = TRUE, 
                            na.omit = FALSE, warn.dropped = TRUE)

#check for dropped tips or dropped species
edcd.comp$dropped$tips #phylogeny
edcd.comp$dropped$unmatched.rows #dataset

#run PGLS model for eye diameter vs. SVL using the Maximum Liklihood estimate of lambda
pgls_edcd <- pgls(log10(cornea_av) ~ log10(eye_av), 
               data = edcd.comp, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edcd)

#quick plot of pgls
plot(log10(cornea_av) ~ log10(eye_av), data = av.edcd.phy)
abline(pgls_edcd)

#likelihood profile for lambda from the PGLS model
lambda.edcd <- pgls.profile(pgls_edcd, "lambda")

#SMA fit for eye size on identical dataset
sma_edcd.phy <- sma(formula = cornea_av ~ eye_av,
               robust = TRUE,
               data = av.edcd.phy, 
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

#view model output
summary(sma_edcd.phy)
```

We plotted the likelihood for lambda in our PGLS. 

```{r plot-lambda-edcd, fig.cap = "Likelihood plot for Pagel's lambda from the PGLS model of eye diameter vs. snout-vent length. Solid red line indicates estimate for lambda and broken red lines indcaite the 95% confidence interval. "}

plot(lambda.edcd)

```

For the PGLS of mean cornea diameter vs. mean eye diameter, Pagel's lambda was `r pgls.confint(pgls_edcd, "lambda")$opt` with 95% confidence intervals of `r pgls.confint(pgls_edcd, "lambda")$ci.val`, indicating that there is low phylogenetic signal in the residuals of our PGLS model fit (which is our measure of relative corneal investment).

Next we looked at diagnostic plots for our model. 

```{r plot-diagonstics-edcd, fig.cap = "Model diagnostic plots for PGLS of frog cornea diameter vs. eye diameter."}

par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edcd, main = "PGLS model for mean eye diameter vs. svl")
par(mfrow = c(1, 1))

```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-edcd-nooutliers1}

# refit pgls after removing extreme outliers observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edcd <- residuals(pgls_edcd, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edcd <- phyres.edcd/sqrt(var(phyres.edcd))[1] 

#match species names with standardized residuals
rownames(stphyres.edcd)<-rownames(pgls_edcd$residuals) 

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edcd)[(abs(stphyres.edcd)>3)]
 
#remove these two species from data/tree
edcd.comp.nooutliers <- edcd.comp[-which(abs(stphyres.edcd)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edcd_nooutliers <- pgls(log10(cornea_av) ~ log10(eye_av), 
               data = edcd.comp.nooutliers, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edcd_nooutliers)

#quick plot of pgls
plot(log10(cornea_av) ~ log10(eye_av), data = edcd.comp.nooutliers$data)
abline(pgls_edcd_nooutliers)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edcd_nooutliers, main = "PGLS model for cornea vs. eye (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edcd_nooutliers , "lambda"))
```

The diagnostic plots show that the data conformed to most model assumptions, though we do have species with the absolute value of studentized residuals exceeding 3, which could disproportionately influence the regression. To check whether this is happening, we re-ran the model with outlier species removed. 

```{r pgls-edcd-nooutliers2}

# refit pgls after removing extreme outliers observed in first fit with full dataset (invalidated assumptions of the pgls fit)

#extract the phylogenetic residuals from the original model
phyres.edcd2 <- residuals(pgls_edcd_nooutliers, phylo = TRUE)

#standardize residuals by dividing by the square root of their variance
stphyres.edcd2 <- phyres.edcd2/sqrt(var(phyres.edcd2))[1] 

#match species names with standardized residuals
rownames(stphyres.edcd2)<-rownames(pgls_edcd_nooutliers$residuals) 

#pull the names of the outlier species (where standardized res beyond ±3)
rownames(stphyres.edcd2)[(abs(stphyres.edcd2)>3)]
 
#remove these two species from data/tree
edcd.comp.nooutliers2 <- edcd.comp.nooutliers[-which(abs(stphyres.edcd2)>3), ]

#re-run pgls analisys (without the outliers)
pgls_edcd_nooutliers2 <- pgls(log10(cornea_av) ~ log10(eye_av), 
               data = edcd.comp.nooutliers2, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#print model output 
summary(pgls_edcd_nooutliers2)

#quick plot of pgls
plot(log10(cornea_av) ~ log10(eye_av), data = edcd.comp.nooutliers2$data)
abline(pgls_edcd_nooutliers2)

#diagnostic plots
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_edcd_nooutliers2, main = "PGLS model for cornea vs. eye (no outliers)")
par(mfrow = c(1, 1))

#lambda
plot(pgls.profile(pgls_edcd_nooutliers2 , "lambda"))
```

In this run, there are no studentized residuals with absolute value > 3. As iterative removal of potential outlier species had no effect on model estimates, we use the full dataset in our analyses. 

## PGLS plots and figures

We then plotted the full dataset, species averages, PGLS fits, and SMA fits. 

```{r pgls-plots, fig.height=4, fig.width=8}

#plot for data and PGLS/SMA fits for eye diameter vs. cube root of mass
plot_pgls.edmass <- ggplot(av.edmass.phy, aes(x = rootmass_av, y = eye_av, text = genus_species)) +
 geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "eye diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_edmass.phy)[[2]], intercept = coef(sma_edmass.phy)[[1]], linetype = "dashed") + #plots SMA fit with dashed line
  geom_abline(slope = coef(pgls_edmass)[[2]], intercept = coef(pgls_edmass)[[1]], linetype = "solid") #plots PGLS fit with solid line

#interactive plot
ggplotly(plot_pgls.edmass)

#plot for data and PGLS/SMA fits for eye diameter vs. SVL
plot_pgls.edsvl <- ggplot(av.edsvl.phy, aes(x = svl_av, y = eye_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "eye diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_abline(slope = coef(sma_edsvl.phy)[[2]], intercept = coef(sma_edsvl.phy)[[1]], linetype = "dashed") + #plots SMA fit with dashed line
  geom_abline(slope = coef(pgls_edsvl)[[2]], intercept = coef(pgls_edsvl)[[1]], linetype = "solid") #plots PGLS fit with solid line

#interactive plot
ggplotly(plot_pgls.edsvl)

#plot for data and PGLS/SMA fits for cornea diameter vs. eye diameter
plot_pgls.edcd <- ggplot(av.edcd.phy, aes(x = eye_av, y = cornea_av, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat)) +
  scale_color_manual(values = col_hab) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "eye diameter (mm)") +
  geom_abline(slope = coef(sma_edcd.phy)[[2]], intercept = coef(sma_edcd.phy)[[1]], linetype = "dashed") + #plots SMA fit with dashed line
  geom_abline(slope = coef(pgls_edcd)[[2]], intercept = coef(pgls_edcd)[[1]], linetype = "solid") #plots PGLS fit with solid line

#interactive plot
ggplotly(plot_pgls.edcd)
```

Here, we reproduce Figure 2 of the manuscript. 

```{r figure-2}
#plot for eye vs rootmass SMA fits and PGLS by habitat group
fig.a <- ggplot(frogs, aes(x = rootmass, y = eyemean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat), size = 1.3) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "eye diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_point(data = av.edmass.hab, aes(x = rootmass_av, y = eye_av, fill = Adult_habitat), alpha = 1, pch = 21, size = 1) +
  scale_fill_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  geom_abline(slope = coef(sma_edmass)[[2]], intercept = coef(sma_edmass)[[1]], linetype = "dashed") + #plots SMA fit with dashed line 
  geom_abline(slope = coef(pgls_edmass)[[2]], intercept = coef(pgls_edmass)[[1]], linetype = "solid") + #plots PGLS fit with solid line
  theme(legend.position = "none")

#plot for eye vs SVL SMA fits by habitat group
fig.b <- ggplot(frogs, aes(x = SVL_mm, y = eyemean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat), size = 1.3) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "eye diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_point(data = av.edsvl.hab, aes(x = svl_av, y = eye_av, fill = Adult_habitat), alpha = 1, pch = 21, size = 1) +
  scale_fill_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  geom_abline(slope = coef(sma_edsvl)[[2]], intercept = coef(sma_edsvl)[[1]], linetype = "dashed") + #plots SMA fit with dashed line 
  geom_abline(slope = coef(pgls_edsvl)[[2]], intercept = coef(pgls_edsvl)[[1]], linetype = "solid") + #plots PGLS fit with solid line
  theme(legend.position = "none")

#plot for eye vs SVL SMA fits by habitat group
fig.c <- ggplot(frogs, aes(x = eyemean, y = cormean, text = genus_species)) +
  geom_point(alpha = 0.6, aes(color = Adult_habitat), size = 1.3) +
  scale_color_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "eye diameter (mm)") +
  geom_point(data = av.edcd.hab, aes(x = eye_av, y = cornea_av, fill = Adult_habitat), alpha = 1, pch = 21, size = 1) +
  scale_fill_manual(values = col_hab, na.translate=TRUE, na.value="gray50", name = "Habitat") +
  geom_abline(slope = coef(sma_edcd)[[2]], intercept = coef(sma_edcd)[[1]], linetype = "dashed") + #plots SMA fit with dashed line 
  geom_abline(slope = coef(pgls_edcd)[[2]], intercept = coef(pgls_edcd)[[1]], linetype = "solid") + #plots PGLS fit with solid line
  theme(legend.position = "none")

# extract legend from one figure
leg <- get_legend(plot_edsvl + theme(legend.position = "right"))

#use cowplot package to nicely plot the graphs together with a shared common legend.
plots <- plot_grid(fig.a, fig.b, fig.c, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("A", "B", "C"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of columns in grids

#construct full figure with panels and legend
pdf("../figure2.pdf", width=10, height=2.5)
plot_grid(plots, leg, ncol=2, rel_widths = c(1, 0.15), align = 'vh')
dev.off()

```

# Eye scaling in fresh specimens vs. museum preserved specimens

To test whether our use of external eye and corneal diameter measurements from muesum specimens were providing reasonable approximations, we compared our preserved museum specimen dataset to a small field-sampled dataset we collected on fresh frogs. 

```{r fresh-frogs}
#import data on fresh frog eye measurements to convert transverse to axial measurements
fresh.frogs <- data.frame(read.csv("../Data/fresh_data.csv", header=TRUE, na.strings=c("", "NA", " "))) #load raw data

#linear model to predict axial diameter from external transverse diameter of eye
mod_edad <- lm(AD_mm_dissected ~ ED_mm_insitu, fresh.frogs)

summary(mod_edad)

plot_edad <- ggplot(fresh.frogs, aes(x = ED_mm_insitu, y = AD_mm_dissected, text = Genus)) +
  geom_point(alpha = 0.5) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  xlab("external transverse diameter (mm)") +
  ylab("dissected axial length (mm)") +
  geom_abline(slope = coef(mod_edad)[[2]], intercept = coef(mod_edad)[[1]], linetype = "solid", alpha = 1)  

ggplotly(plot_edad)

#linear model to predict dissected transverse diameter from external transverse diameter of eye
mod_eddd <- lm(ED_mm_dissected ~ ED_mm_insitu, fresh.frogs)

summary(mod_eddd)

plot_eddd <- ggplot(fresh.frogs, aes(x = ED_mm_insitu, y = ED_mm_dissected, text = Genus)) +
  geom_point(alpha = 0.5) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  xlab("external transverse diameter (mm)") +
  ylab("dissected transverse diameter (mm)") +
  geom_abline(slope = coef(mod_eddd)[[2]], intercept = coef(mod_eddd)[[1]], linetype = "solid", alpha = 1)  

ggplotly(plot_eddd)
```

Then we compared eye scaling in fresh frogs to eye scaling in preserved museum specimens. We did this testing for significant differences in SMA fits across our fresh specimen data vs. our preserved specimen data. 

```{r freshpres-comp}

# Comparison of eye scaling in preserved frogs vs. fresh frogs. 

#merge museum (preserved) dataset and fresh frog dataset

#preserved dataset
preserved <- av.edmass %>%
  mutate(cornea = cormean, eye.ex = eyemean, eyecomp = eyemean) %>%
  mutate(group = as.factor("preserved specimens")) %>%
  select(Family, genus_species, group, rootmass, SVL_mm, cornea, eye.ex, eyecomp)
  
#fresh dataset
fresh <- fresh.frogs %>%
  mutate(genus_species = as.factor(paste(fresh.frogs$Genus, fresh.frogs$Species, sep="_"))) %>%
  mutate(rootmass = (Mass_g)^(1/3), eyecomp = ED_mm_dissected) %>%
  rename(cornea = CD_mm_dissected, eye.ex = ED_mm_insitu) %>%
  mutate(group = as.factor("fresh specimens")) %>%
  select(Family, genus_species, group, rootmass, SVL_mm, cornea, eye.ex, eyecomp, ED_mm_dissected, AD_mm_dissected)

#merged dataset
fresh.pres <- merge(preserved, fresh, all = TRUE)

#Test whether SMA fits are different for fresh vs. preserved frog datasets

# for external transverse eye diameter ~ cuberoot of mass
sma_exeye.mass <- sma(formula = eye.ex ~ rootmass + group, #test for slope difference and elevation difference
                robust = TRUE,
               data = fresh.pres,
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_exeye.mass)
plot(sma_exeye.mass)

col_fp <- c("preserved specimens" = "goldenrod",
            "fresh specimens" = "black")

plot_exeye.mass <- ggplot(fresh.pres, aes(x = rootmass, y = eye.ex, text = genus_species)) +
  geom_point(aes(color = group), size=1, alpha = 0.5) +
  scale_color_manual(values = col_fp) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "external eye diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_exeye.mass)[[2]], intercept = coef(sma_exeye.mass)[[1]], linetype = "dashed", color = col_fp, alpha = 1)   #plots SMA fits with dashed line
  
ggplotly(plot_exeye.mass)

# for external transverse eye diamter in museum specimens vs. cuberoot of mass and dissected transverse eye diamter in fresh specimens vs. cuberoot of mass
sma_diffeye.mass <- sma(formula = eyecomp ~ rootmass + group, #test for slope difference and elevation difference
              robust = TRUE,
               data = fresh.pres,
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_diffeye.mass)
plot(sma_diffeye.mass)

# for external transverse eye diameter ~ SVL
sma_exeye.svl <- sma(formula = eye.ex ~ SVL_mm * group, #test for slope difference and elevation difference
                      robust = TRUE,
               data = fresh.pres,
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_exeye.svl)
plot(sma_exeye.svl)

plot_exeye.svl <- ggplot(fresh.pres, aes(x = SVL_mm, y = eye.ex, text = genus_species)) +
  geom_point(aes(color = group), size=1, alpha = 0.5) +
  scale_color_manual(values = col_fp) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "external eye diameter (mm)") +
  scale_x_log10(name = "SVL (mm)") +
  geom_abline(slope = coef(sma_exeye.svl)[[2]], intercept = coef(sma_exeye.svl)[[1]], linetype = "dashed", color = col_fp, alpha = 1)   #plots SMA fits with dashed line
  
ggplotly(plot_exeye.svl)

# for external transverse eye diamter in museum specimens vs. SVL and dissected transverse eye diamter in fresh specimens vs. SVL
sma_diffeye.svl <- sma(formula = eyecomp ~ SVL_mm * group, #test for slope difference and elevation difference
              robust = TRUE,
               data = fresh.pres,
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_diffeye.svl)
plot(sma_diffeye.svl)
```

Then we made a pdf figure of fresh frog scaling relationships for the paper supplement. 

```{r fresh-fig}

#make panels 
fig.a <- plot_edad +
  theme(legend.position = "none", text = element_text(size=12))

fig.b <- plot_eddd +
  theme(legend.position = "none", text = element_text(size=12))

fig.c <- plot_exeye.mass +
  theme(legend.position = "none", text = element_text(size=12))

fig.d <- plot_exeye.svl +
  theme(legend.position = "none", text = element_text(size=12))

#plots
plots <- plot_grid(fig.a, fig.b, fig.c, fig.d, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("A", "B", "C", "D"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 2) #number of rows in gridss

# extract legend
leg <- get_legend(plot_exeye.svl + theme(legend.position = "right"))

#export pdf of figure
pdf("../figure-freshfrogs.pdf", width=10, height=7)
plot_grid(plots, leg, ncol = 2, rel_widths = c(1, 0.2), align = 'vh')
dev.off()
```

# Eye scaling in frogs compared to other vertebrates

After determinining how eyes scale with body size in frogs, we then wanted to compare to eye scaling in other vertebrates. Some papers that have examined eye scaling have looked eyes relative to body mass, and others relative to body length. We measured both mass and SVL in frogs so that we could compare across more studies, but we must compare separately for each measure of body size. 

First we looked at axial eye length versus the cube root of mass across measured vertebrates (frogs, mammals, birds, reptiles, fishes). 

```{r scaling-verts-axial, fig.height = 4, fig.width =9, fig.cap = "Slopes among vertebrate groups are not equal (p<0.001)."}

# Scaling of eye axial diameter with mass across vertebrates. 

#import data from Howland et al. 2004
verts <- data.frame(read.csv("../Data/other verts/vertebrates.csv", header=TRUE, na.strings=c("", "NA", " "))) #load raw data

verts.sub <- verts %>%
  mutate(mass_g = Wt.in.kg*1000) %>%
  mutate(rootmass = mass_g^(1/3)) %>%
  mutate(Group = recode_factor(Group, "Rodents" = "Mammals", "Primates" = "Mammals", "Mammals" = "Mammals", "Birds" = "Birds", "Reptiles" = "Reptiles", "Fishes" = "Fishes")) %>%
  rename(Name = Scientific.name, Eye = Axial..mm., Mass = rootmass) %>%
  select(Name, Mass, Eye, Group) %>%
  filter(Group != "Amphibians") #remove the sparse amphibians from Howland et al.

# import mammal data from Veilleux and Kirk 2014
mams <- data.frame(read.csv("../Data/other verts/mammals.csv", header=TRUE, na.strings=c("", "NA", " "))) 

mams.sub <- mams %>%
  mutate(rootmass = (Body.mass..kg.*1000)^(1/3)) %>%
  rename(Name = Species, Mass = rootmass, Eye = Axial.diameter..mm.) %>%
  mutate(Group = "Mammals") %>%
  select(Name, Mass, Eye, Group)

#subset frog data and add group name
frogs.mass <- av.edmass %>%
  mutate(eye.axial = coef(mod_edad)[[2]]*eye_av + coef(mod_edad)[[1]]) %>%
  rename(Name = genus_species, Mass = rootmass, Eye = eye.axial) %>%
  mutate(Group = "Frogs") %>%
  select(Name, Mass, Eye, Group)

#join datasets together
vertebrates <- rbind(verts.sub, mams.sub, frogs.mass)

#see number of each Group
table(vertebrates$Group)

#SMA fits for vertebrate groups
sma_verts <- sma(formula = Eye ~ Mass * Group,
               robust = TRUE,
               data = vertebrates, 
               multcomp = TRUE,
               multcompmethod = "adjusted",
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

print(sma_verts)
summary(sma_verts)
plot(sma_verts)

#make color vector for groups
col_verts <- c("Mammals" = "#ff7f00", 
               "Birds" = "#e41a1c",
               "Reptiles" = "#984ea3",
               "Fishes" = "#377eb8",
               "Frogs" = "#4daf4a")

#make shape vector for groups
sh_verts <- c("Mammals" = 22, 
               "Birds" = 24,
               "Reptiles" = 23,
               "Fishes" = 25,
               "Frogs" = 21)

#plot
plot_verts <- ggplot(vertebrates, aes(x = Mass, y = Eye, text = Name)) +
  geom_point(aes(color = Group, fill = Group, shape = Group), size = 1, alpha = 0.5) +
  scale_color_manual(values = col_verts, 
                     name = "", 
                     breaks = c("Frogs","Birds","Reptiles","Fishes","Mammals"),
                     labels = c(expression(paste("Anurans"^1)), 
                              expression(paste("Birds"^2)),
                              expression(paste("Reptiles"^2)),
                              expression(paste("Fishes"^2)),
                              expression(paste("Mammals"^"2,3")))) +
  scale_fill_manual(values = col_verts, 
                    name = "",
                    breaks = c("Frogs","Birds","Reptiles","Fishes","Mammals"),
                    labels = c(expression(paste("Anurans"^1)), 
                              expression(paste("Birds"^2)),
                              expression(paste("Reptiles"^2)),
                              expression(paste("Fishes"^2)),
                              expression(paste("Mammals"^"2,3")))) +
  scale_shape_manual(values = sh_verts, 
                     name = "", 
                     breaks = c("Frogs","Birds","Reptiles","Fishes","Mammals"),
                    labels = c(expression(paste("Anurans"^1)), 
                              expression(paste("Birds"^2)),
                              expression(paste("Reptiles"^2)),
                              expression(paste("Fishes"^2)),
                              expression(paste("Mammals"^"2,3")))) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text.align = 0) +
  scale_y_log10(name = "axial eye length (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_verts)[[2]], intercept = coef(sma_verts)[[1]], linetype = "dashed", alpha = 1, color = col_verts)  #plots SMA fits with dashed line

ggplotly(plot_verts)
```

Then we looked at axial eye diameter vs. snout-vent length in frogs and lizards. 

```{r scaling-verts-adsvl}

#Scaling of eye axial diameter and corneal diameter vs. snout-vent length across frogs and lizards

#import lizard data from Hall (2008)
liz <- data.frame(read.csv("../Data/other verts/lizards.csv", header=TRUE, na.strings=c("", "NA", " "))) 

liz.sub <- liz %>%
  rename(Name = Taxon, SVL = Snout.vent.length..mm., Eye = Axial.length..mm., Cornea = Corneal.diameter..mm.) %>%
  mutate(Group = as.factor("Lizards")) %>%
  select(Name, SVL, Eye, Cornea, Group)

#subset frog data and add group name
frogs.trans <- av.edsvl %>%
  mutate(eye.axial = coef(mod_edad)[[2]]*eye_av + coef(mod_edad)[[1]]) %>%
  rename(Name = genus_species, SVL = SVL_mm, Eye = eye.axial, Cornea = cormean) %>%
  mutate(Group = as.factor("Frogs")) %>%
  select(Name, SVL, Eye, Cornea, Group)

#join datasets together
trans.svl <- rbind(liz.sub, frogs.trans)

#see number of each Group
table(trans.svl$Group)

#SMA fits for axial eye length
sma_trans.svl.eye <- sma(formula = Eye ~ SVL * Group,
               robust = TRUE,
               data = trans.svl,
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_trans.svl.eye)
plot(sma_trans.svl.eye)

#SMA fits for corneal diameter
sma_trans.svl.cor <- sma(formula = Cornea ~ SVL + Group,
               robust = TRUE,
               data = trans.svl,
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_trans.svl.cor)
plot(sma_trans.svl.cor)

#make color vector for groups
col_adsvl <- c("Lizards" = "#984ea3",
               "Frogs" = "#4daf4a")
              
#make shape vector for groups
sh_adsvl <- c("Frogs" = 21,
               "Lizards" = 23)


#plot
plot_adcd.svl <- ggplot(trans.svl, aes(x = SVL, y = Eye, text = Name)) +
  geom_point(aes(color = Group, fill = Group, shape = Group), size=1, alpha = 0.5) +
  scale_color_manual(values = col_adsvl, 
                     name = "",
                     breaks = c("Frogs","Lizards"),
                     labels = c(expression(paste("Anurans"^1)), 
                                expression(paste("Lizards"^7)))) +
  scale_fill_manual(values = col_adsvl, 
                     name = "",
                     breaks = c("Frogs","Lizards"),
                     labels = c(expression(paste("Anurans"^1)), 
                                expression(paste("Lizards"^7)))) +
  scale_shape_manual(values = sh_adsvl, 
                     name = "",
                     breaks = c("Frogs","Lizards"),
                     labels = c(expression(paste("Anurans"^1)), 
                                expression(paste("Lizards"^7)))) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text.align = 0) +
  scale_y_log10(name = "axial eye length (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_abline(slope = coef(sma_trans.svl.eye)[[2]], intercept = coef(sma_trans.svl.eye)[[1]], linetype = "dashed", color = col_adsvl, alpha = 1)   #plots SMA fits with dashed line
  
ggplotly(plot_adcd.svl)

```

Then we looked at transverse eye diameter versus the cube root of mass across frogs and acanthomorph fishes. 

```{r scaling-verts-transverse, fig.height = 4, fig.width = 8, fig.cap = ""}

# Scaling of eyes with mass across vertebrates

#import acanthomorph fish data from schmitz et al 2013
acanth <- data.frame(read.csv("../Data/other verts/acanthomorph_fish.csv", header=TRUE, na.strings=c("", "NA", " "))) 

acanth.sub <- acanth %>%
  mutate(rootmass = BM..g.^(1/3)) %>%
  rename(Name = species, Mass = rootmass, Eye = ED..mm.) %>%
  mutate(Group = as.factor("Acanthomorph fishes")) %>%
  select(Name, Mass, Eye, Group)

#subset frog data and add group name
frogs.transverse <- av.edsvl %>%
  rename(Name = genus_species, Mass = rootmass, Eye = eye_av) %>%
  mutate(Group = as.factor("Frogs")) %>%
  select(Name, Mass, Eye, Group)

#join datasets together
trans <- rbind(acanth.sub, frogs.transverse)

#see number of each Group
table(trans$Group)

#SMA fits for vertebrate groups
sma_trans <- sma(formula = Eye ~ Mass * Group,
               robust = TRUE,
               data = trans,
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_trans)
plot(sma_verts)

#make shape vector for groups
sh_trans <- c("Acanthomorph fishes" = 25,
               "Frogs" = 21)
#make color vector for groups
col_trans <- c("Acanthomorph fishes" = "#377eb8",
               "Frogs" = "#4daf4a")

#plot
plot_trans <- ggplot(trans, aes(x = Mass, y = Eye, text = Name)) +
  geom_point(aes(color = Group, fill = Group, shape = Group), size = 1, alpha = 0.5) +
  scale_color_manual(values = col_trans, 
                     name = "", 
                     breaks = c("Frogs", "Acanthomorph fishes"), 
                     labels = c(expression(paste("Anurans"^1)), 
                                expression(paste("Acanthomorph fishes"^4)))) +
  scale_fill_manual(values = col_trans, 
                     name = "", 
                     breaks = c("Frogs", "Acanthomorph fishes"), 
                     labels = c(expression(paste("Anurans"^1)), 
                                expression(paste("Acanthomorph fishes"^4)))) +
  scale_shape_manual(values = sh_trans, 
                     name = "", 
                     breaks = c("Frogs", "Acanthomorph fishes"), 
                     labels = c(expression(paste("Anurans"^1)), 
                                expression(paste("Acanthomorph fishes"^4)))) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text.align = 0) +
  scale_y_log10(name = "transverse eye diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_trans)[[2]], intercept = coef(sma_trans)[[1]], linetype = "dashed", alpha = 1, color = col_trans)
              
ggplotly(plot_trans)
```

Finally, we looked at transverse eye diameter versus snout-vent length across frogs, geckos, and snakes. 

```{r scaling-verts-length, fig.height=4, fig.width=8, fig.cap="SMA slopes for frogs, geckos, and snakes are not significantly different (p = 0.06), though the intercepts are significantly different across all pairwise comparisons (p < 0.001). SMA fits for all groups showed close to isometric growth of eye diameter with body length (frogs: a = 0.97, b = -0.87; geckos: a = 0.97, b = -1.19; snakes: a = 0.97, b = -2.14)"}

# Scaling of eyes with body length across vertebrates

#import snake data from Liu et al 2012
snakes <- data.frame(read.csv("../Data/other verts/colubrid_snakes.csv", header=TRUE, na.strings=c("", "NA", " "))) # data from Liu et al 2012

snakes.sub <- snakes %>%
  rename(Name = Scientific.name, Length = SVL..mm., Eye = ED..mm.) %>%
  mutate(Group = "Snakes") %>%
  select(Name, Length, Eye, Group)

#import gecko data from Werner and Seifan 2006
geckos <- data.frame(read.csv("../Data/other verts/geckos.csv", header=TRUE, na.strings=c("", "NA", " "))) # data from Werner and Seifan 2006

geckos.sub <- geckos %>%
  rename(Name = X.Taxon..species.and.subspecies., Length = X.rostrum.anus..mm., Eye = eye..mm.) %>%
  mutate(Group = "Geckos") %>%
  select(Name, Length, Eye, Group)

#format frog data from this study
frogs.sub <- av.edsvl %>%
  rename(Name = genus_species, Length = SVL_mm, Eye = eye_av) %>%
  mutate(Group = "Frogs") %>%
  select(Name, Length, Eye, Group)

#combine datasets
vert.length <- rbind(snakes.sub, geckos.sub, frogs.sub)

#see number of each Group
table(vert.length$Group)

#SMA fits by group (slope estimate only)
sma_vert.length <- sma(formula = Eye ~ Length * Group,
               robust = TRUE,
               data = vert.length, 
               multcomp = TRUE,
               multcompmethod = "adjusted",
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_vert.length)


#SMA fits by group 
sma_vert.length <- sma(formula = Eye ~ Length + Group, #test for differences in slope AND intercept
               robust = TRUE,
               data = vert.length, 
               multcomp = TRUE,
               multcompmethod = "adjusted",
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_vert.length)

#make color vector for groups
col_vert.length <- c("Frogs" = "#4daf4a",
               "Geckos" = "#984ea3",
               "Snakes" = "#e7298a")
              
#make shape vector for groups
sh_vert.length <- c("Frogs" = 21,
               "Geckos" = 23,
               "Snakes" = 22)

#plot
plot_length <- ggplot(vert.length, aes(x = Length, y = Eye, text = Name)) +
  geom_point(aes(color = Group, fill = Group, shape = Group), size=1, alpha = 0.5) +
  scale_color_manual(values = col_vert.length, 
                     name = "",
                     breaks = c("Frogs","Geckos","Snakes"),
                     labels = c(expression(paste("Anurans"^1)), 
                                expression(paste("Geckos"^5)),
                                expression(paste("Snakes"^6)))) +
  scale_fill_manual(values = col_vert.length, 
                     name = "",
                     breaks = c("Frogs","Geckos","Snakes"),
                     labels = c(expression(paste("Anurans"^1)), 
                                expression(paste("Geckos"^5)),
                                expression(paste("Snakes"^6)))) +
  scale_shape_manual(values = sh_vert.length, 
                     name = "",
                     breaks = c("Frogs","Geckos","Snakes"),
                     labels = c(expression(paste("Anurans"^1)), 
                                expression(paste("Geckos"^5)),
                                expression(paste("Snakes"^6)))) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text.align = 0) +
  scale_y_log10(name = "transverse eye diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_abline(slope = coef(sma_vert.length)[[2]], intercept = coef(sma_vert.length)[[1]], linetype = "dashed", color = col_vert.length, alpha = 1)  #plots SMA fits with dashed line

ggplotly(plot_length)

```

```{r verts-figure, fig.width=12, fig.height=15}

#make panels 
fig.a <- plot_verts +
  theme(legend.position = "bottom", text = element_text(size=12))

fig.b <- plot_trans +
  theme(legend.position = "bottom", text = element_text(size=12))

fig.c <- plot_adcd.svl +
  theme(legend.position = "bottom", text = element_text(size=12))

fig.d <- plot_length +
  theme(legend.position = "bottom", text = element_text(size=12))


#use cowplot package to nicely plot the graphs together with a shared common legend.
plots <- plot_grid(fig.a, fig.b, fig.c, fig.d, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("A", "B", "C", "D"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           vjust = 1,
           nrow = 2) #number of columns in grids

#export pdf of figure
pdf("../figure3-verts.pdf", width=10.5, height=7)
plot_grid(plots)
dev.off()
```

***

# Eye scaling in frogs compared to Huang et al. (2019)

We compared our results for eye scaling from this study to a recently published study by Huang et al. (2019). Huang et al. measured corneal diameter (from photographs) and both mass and svl. 

First we imported Huang et al.'s data and back-calculated their raw corneal diameter measurements from their published, calculated "eye volume" data and an equation provided in their methods. We also subset our own corneal diameter data from both museum specimens and from freshly caught field specimens to compare. Finally, to examine whether differential familial sampling could explain differences in our results vs. Huang et al's results, we subset our museum specimen data to exclude families not sampled by Huang. 

```{r frog-comp-data}

# Scaling of eyes with mass and svl in frogs (this study vs. Huang et al. 2019)

#import frog data from Huang et al. 2019
huang <- data.frame(read.csv("../Data/other verts/anurans.csv", header=TRUE, na.strings=c("", "NA", " "))) 

#Huang et al. 2019 calculated eye volume based on corneal radius via the equation: eye size = 2*1.33*pi*b^3 ,where b is corneal radius. Thus, b = cube root of (.5eye/1.33pi), and corneal diameter is twice that. 
huang.sub <- huang %>%
  mutate(rootmass = (Mass_g)^(1/3)) %>%
  mutate(cornea_mm = (2*(((Eye_vol_mm3/2)/(1.33*pi))^(1/3)))) %>%
  rename(Name = Species, Mass = rootmass, Cornea = cornea_mm) %>%
  mutate(Group = as.factor("Huang et al. 2019")) %>%
  select(Family, Name, Mass, SVL_mm, Cornea, Group)

#subset preserved frog data and add group name
frogs.corneas <- frogs %>%
  rename(Name = genus_species, Mass = rootmass, Cornea = cormean) %>%
  mutate(Group = as.factor("Museum specimens")) %>%
  select(Family, Name, Mass, SVL_mm, Cornea, Group)

#subset fresh frog data and add group name
frogs.fresh <- fresh.frogs %>%
  mutate(rootmass = (Mass_g)^(1/3)) %>%
  rename(Name = Genus, Mass = rootmass, Cornea = CD_mm_dissected) %>%
  mutate(Group = as.factor("Fresh specimens")) %>%
  select(Family, Name, Mass, SVL_mm, Cornea, Group)

#create a subset of our museum data where the families sampled are limited to the families sampled by Huang et al. (2019)
frogs.famsub <- frogs.corneas[frogs.corneas$Family %in% huang.sub$Family, ] %>% #subset our frogs based on family match in Huang data
   mutate(Group = as.factor("Museum (Huang families)"))

#join datasets together
frogcomp <- rbind(huang.sub, frogs.corneas, frogs.fresh, frogs.famsub)
```

Then we used an SMA test in smatr to determine whether corneal scaling with body size was the same for Huang's data, our museum specimen data, our fresh specimen data, and our subset of museum specimen data that excluded families not sampled by Huang et al. 

```{r frog-comp-smas}

# SMA test whether there are any differences in slope or intercept for our preserved specimens, fresh specimens, or subset of families matching Huang et al. sampling for corneal diameter vs. the cube root of mass
sma_frpr.mass <- sma(formula = Cornea ~ Mass + Group, #test for slope AND elevation diff.
               robust = TRUE,
               data = filter(frogcomp, Group != "Huang et al. 2019"),
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_frpr.mass)
plot(sma_frpr.mass)

#SMA test whether there are any differences in slope or intercept for our preserved specimens, fresh specimens, subset of families matching Huang et al. sampling, or Huang et al.'s data for corneal diameter vs. the cube root of mass
sma_frogcomp.mass <- sma(formula = Cornea ~ Mass + Group, #test for slope diff
               robust = TRUE,
               data = frogcomp,
               log = "xy",
               method = "SMA", 
               multcomp = TRUE,
               multcompmethod = "adjusted",
               alpha = 0.05)

plot(sma_frogcomp.mass)
summary(sma_frogcomp.mass)
multcompmatrix(sma_frogcomp.mass)


# SMA test whether there are any differences in slope or intercept for our preserved specimens, fresh specimens, or subset of families matching Huang et al. sampling for corneal diameter vs. SVL
sma_frpr.svl <- sma(formula = Cornea ~ SVL_mm + Group, #test for slope AND elevation diff.
               robust = TRUE,
               data = filter(frogcomp, Group != "Huang et al. 2019"),
               log = "xy",
               method = "SMA", 
               alpha = 0.05)

summary(sma_frpr.svl)
plot(sma_frpr.svl)

#SMA test whether there are any differences in slope or intercept for our preserved specimens, fresh specimens, subset of families matching Huang et al. sampling, or Huang et al.'s data for corneal diameter vs. SVL
sma_frogcomp.svl <- sma(formula = Cornea ~ SVL_mm + Group, #test for slope diff
               robust = TRUE,
               data = frogcomp,
               log = "xy",
               method = "SMA", 
               multcomp = TRUE,
               multcompmethod = "adjusted",
               alpha = 0.05)

plot(sma_frogcomp.svl)
summary(sma_frogcomp.svl)
multcompmatrix(sma_frogcomp.svl)
```

Finally, we created plots showing the data and SMA fits. 

```{r frog-comp-plots}
#make color vector for groups
col_frogcomp <- c("Huang et al. 2019" = "#F28E2B",
               "Museum specimens" = "#59A14F",
               "Fresh specimens" = "#B07AA1", 
               "Museum (Huang families)" = "#39737c")

sh_frogcomp <- c("Huang et al. 2019" = 22,
               "Museum specimens" = 21,
               "Fresh specimens" = 21, 
               "Museum (Huang families)" = 21)

#plot for cornea diameter v. cube root mass
plot_frogcomp.mass <- ggplot(frogcomp, aes(x = Mass, y = Cornea, text = Name)) +
  geom_point(aes(color = Group), alpha = 0.5) +
  scale_color_manual(values = col_frogcomp, 
                     name = "Frog dataset",
                     breaks = c("Museum specimens",
                                "Museum (Huang families)",
                                "Fresh specimens",
                                "Huang et al. 2019"),
                    labels = c("Museum - all",
                                "Museum - subset",
                                "Fresh",
                                "Huang et al.")) +
  scale_shape_manual(values = sh_frogcomp, 
                     name = "Frog dataset") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "cube root of mass (g)") +
  geom_abline(slope = coef(sma_frogcomp.mass)[[2]], intercept = coef(sma_frogcomp.mass)[[1]], linetype = "dashed", alpha = 1, color = col_frogcomp)
              
ggplotly(plot_frogcomp.mass)

#plot for cornea diameter v. svl
plot_frogcomp.svl <- ggplot(frogcomp, aes(x = SVL_mm, y = Cornea, text = Name)) +
  geom_point(aes(color = Group), alpha = 0.5) +
  scale_color_manual(values = col_frogcomp, 
                     name = "Frog dataset",
                     breaks = c("Museum specimens",
                                "Museum (Huang families)",
                                "Fresh specimens",
                                "Huang et al. 2019"),
                    labels = c("Museum - all",
                                "Museum - subset",
                                "Fresh",
                                "Huang et al.")) +
  scale_shape_manual(values = sh_frogcomp, 
                     name = "Frog dataset") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_log10(name = "cornea diameter (mm)") +
  scale_x_log10(name = "snout-vent length (mm)") +
  geom_abline(slope = coef(sma_frogcomp.svl)[[2]], intercept = coef(sma_frogcomp.svl)[[1]], linetype = "dashed", alpha = 1, color = col_frogcomp)
              
ggplotly(plot_frogcomp.svl)

```

Then exported our plots to a pdf figure. 

```{r frogcomp-figure, fig.width = 10, fig.height = 10}

#make panels 
fig.a <- plot_frogcomp.mass +
  theme(legend.position = "none", text = element_text(size=12))

fig.b <- plot_frogcomp.svl +
  theme(legend.position = "none", text = element_text(size=12))

#use cowplot package to nicely plot the graphs together with a shared common legend.
plots <- plot_grid(fig.a, fig.b, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("A", "B"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 2) #number of rows in grids

# extract legends from figures
leg <- get_legend(plot_frogcomp.svl + theme(legend.position = "right"))

#construct full figure with panels and legend
plot_grid(plots, leg, ncol = 2, rel_widths = c(1, 0.5), align = 'vh')

#export pdf of figure
pdf("../figure-frogcomp.pdf", width=8, height=8)
plot_grid(plots, leg, ncol = 2, rel_widths = c(1, 0.3), align = 'vh')
dev.off()
```


# Relative eye size and eye investment in frogs

To investigate how relative eye size differed across species with different ecological traits, we looked at the residuals from PGLS fits of eye diameter vs. body size. 

First, we added residuals of PGLS fits to our datasets by species. 

```{r pgls-residuals}

#Add residuals from PGLS fits to dataframes

#residuals for PGLS of eye diameter ~ cube root of mass
pglsres.edmass <- residuals(pgls_edmass) #extract pgls residuals 
colnames(pglsres.edmass) <- "pglsres.edmass" #name residuals
rownames(av.edmass.phy) <- av.edmass.phy$mod_tiplabel #add rownames to original dataframe
av.edmass.phy <- merge(av.edmass.phy, pglsres.edmass, by = "row.names") #merge residuals with original data by rowname

#residuals for PGLS of eye diameter ~ SVL
pglsres.edsvl <- residuals(pgls_edsvl) #extract pgls residuals
colnames(pglsres.edsvl) <- "pglsres.edsvl" #name residuals
rownames(av.edsvl.phy) <- av.edsvl.phy$mod_tiplabel #add rownames to original dataframe
av.edsvl.phy <- merge(av.edsvl.phy, pglsres.edsvl, by = "row.names") #merge residuals with original data by rowname

#residuals for PGLS of cornea diameter ~ eye diameter
pglsres.edcd <- residuals(pgls_edcd) #extract pgls residuals
colnames(pglsres.edcd) <- "pglsres.edcd" #name residuals
rownames(av.edcd.phy) <- av.edcd.phy$mod_tiplabel #add rownames to original dataframe
av.edcd.phy <- merge(av.edcd.phy, pglsres.edcd, by = "row.names") #merge residuals with original data by rowname
```

## Phylogenetic distribution of absolute and relative eye size

We then plotted absolute eye size and relative eye investment (represented by the residual of the eye size vs. body size PGLS) onto the anuran phylogeny. 

```{r plot-phytools, fig.height = 15, fig.width = 8}

#create vector of colors for activity period
col_act <- c("Both" = "deeppink3",
             "Diurnal" = "darkgoldenrod1", 
             "Nocturnal" = "blueviolet",
             "Unknown" = "gray")

# create vector of colors for life history
col_mat <- c("Ground" = "wheat4", 
         "Lentic water" = "royalblue1", 
         "Lotic water" = "skyblue1",
         "Plants" = "springgreen3",
         "Unknown" = "gray")


# create vector of colors for life history
col_lif <- c("Free-living larvae" = "darkturquoise", 
         "No free-living larvae" = "black", 
         "Unknown" = "gray")

# create vector of colors for larval habitat
col_larv <- c("Lentic water" = "royalblue1", 
         "Lotic water" = "skyblue1",
         "No larvae" = "lightcoral",
         "Obscured" = "darkslateblue",
         "On land" = "lightpink4",
         "Unknown" = "gray")

# create vector of colors for sex dichromatism
col_dich <- c("Absent" = "black", 
         "Present" = "chartreuse2",
         "Unknown" = "gray")



# Plot traits onto phylogeny using phytools

#subset data for eye diameter and mass
edmass.bars <- av.edmass.phy %>%
  mutate(oldtip = mod_tiplabel, 
         newtip = genus_species, 
         abseye = eye_av, 
         inveye = pglsres.edmass, 
         hab = Adult_habitat,
         act = Activity_period, 
         mat = Mating_habitat,
         lif = Life_history,
         larv = Larval_habitat,
         dich = Sex_dichromatism) %>%
  select(oldtip, newtip, abseye, inveye, hab, act, mat, lif, larv, dich)

# set row names in dataset to match the tip labels in the tree
row.names(edmass.bars) <- edmass.bars$newtip

#drop phylogeny tips not in dataset)
tree_edmass <- drop.tip(tree_pruned, tree_pruned$tip.label[!(tree_pruned$tip.label %in% edmass.bars$oldtip)])
tree_edmass <- ladderize(tree_edmass)

# Make Genus_species tip labels based on  Amphibian Species of the World names (and no family at end)
sp.tips <- data.frame(old = av.edmass.phy$mod_tiplabel, new = av.edmass.phy$genus_species)

# replace tip labels in phylogeny
tree_edmass <- sub.taxa.label(tree_edmass, sp.tips)

#check that phylogeny and data match exactly
name.check(tree_edmass, edmass.bars)

#resort trait dataset to the order of tree tip labels
edmass.bars <- edmass.bars[tree_edmass$tip.label, ] 

#make trait vector for absolute eye size
aveye <- as.vector(edmass.bars$abseye) #make vector of absolute eye size
names(aveye) <- edmass.bars$newtip #add tip label names to vector

#make trait vector for eye investment (PGLS residuals)
inv.mass <- as.vector(edmass.bars$inveye) #residuals of pgls
names(inv.mass) <- edmass.bars$newtip

#make trait vector of habitats
habs.edmass <-as.vector(edmass.bars$hab) 

#make vector of colors corresponding to phylogeny tips
tipcols <- unname(col_hab[habs.edmass]) 

## estimate ancestral states for adult habitat under a ER model
fitER <- ace(habs.edmass, tree_edmass, model="ER", type="discrete")
fitER #view ASR model output
#round(fitER$lik.anc,3) #view marginal ancestral states

#### Phylogeny with absolute eye diameters (bars scaled by eye dimeter using phytools) and ancestral state estimation for adult habitat at nodes ####

#colors for plot
cols <- col_hab

#plot tree with eye size bars ant tip labels
plotTree.wBars(tree_edmass, aveye, 
               scale = 0.04, 
               tip.labels = TRUE, 
               offset = 0.35,
               ftype = "bi",
               fsize = 0.8,
               col = tipcols)

#label nodes with pie charts of ancestor state probabilities
nodelabels(node=1:tree_edmass$Nnode+Ntip(tree_edmass),
           pie = fitER$lik.anc, 
           piecol = cols,
           cex = 0.3)
tiplabels(pie = to.matrix(habs.edmass,sort(unique(habs.edmass))),
          piecol = cols,
          cex = 0.2)

#add legend for habitat states
legend(x="left",legend = c("Aquatic", "Fossorial", "Ground-dwelling", "Scans orial", "Semiaquatic", "Subfossorial"), pch = 22, pt.cex= 2, pt.bg = col_hab, cex = 1, bty = "n",horiz = F)

##### Phylogeny with relative eye size (compared to mass) ####

#plot tree with relative eye size bars
plotTree.wBars(tree_edmass, inv.mass, 
               scale = 0.6, 
               tip.labels = FALSE, 
               col = tipcols,
               plot = FALSE, 
               add = TRUE)

```

Figure 4 was compiled in Illustrator, but the component parts of it are exported here. 

```{r figure4-component1}

# Separate panels for Figure 3

#export pdf of phylogeny, habitat ASR, and absolute eye size

pdf(file = "../Fig-4a.pdf", height=25, width=8)

#make vector of colors corresponding to phylogeny tips
tipcols <- unname(col_hab[habs.edmass]) 

#call plot with phylo, tip labels, and absolute eye diameters
plotTree.wBars(tree_edmass, aveye, 
               scale = 0.04, 
               width = 1,
               tip.labels = FALSE, 
               offset = 0.4,
               col = tipcols)
#add ASR estimates at nodes
nodelabels(node=1:tree_edmass$Nnode+Ntip(tree_edmass),
    pie=fitER$lik.anc, piecol=cols, cex=0.4)
#tiplabels(pie=to.matrix(habs.edmass,sort(unique(habs.edmass))),piecol=cols,cex=0.3)

#add legend for habitat state colors
#legend(x="left",legend = c("Aquatic", "Fossorial", "Ground-dwelling", "Scansorial", "Semiaquatic", "Subfossorial"), pch = 22, pt.cex= 2, pt.bg = col_hab, cex = 1, bty = "n",horiz = F)

dev.off()


pdf(file = "../Fig-4a2.pdf", height=25, width=8)
#add bars for eye investment (relative to mass)
plotTree.wBars(tree_edmass, inv.mass, 
               scale = 1.05, 
               width = 1,
               tip.labels = FALSE, 
               col = tipcols,
               plot = FALSE)
dev.off()

```

We made plots of the phylogeny with traits mapped along with ancestral state estimations for supplemental figures as well.

```{r supp-habitat, fig.height = 15, fig.width = 8}

# Phylogeny for adult habitat

#export pdf of phylogeny, habitat ASR, and absolute eye size
pdf(file = "../phylo-habitat.pdf", height=20, width=8)

#make trait vector of activity pattern
hab.edmass <-as.vector(edmass.bars$hab) 

#make vector of colors corresponding to phylogeny tips
tipcols <- unname(col_hab[hab.edmass]) 

## estimate ancestral states for adult habitat under a ER model
fitER <- ace(hab.edmass, tree_edmass, model="ER", type="discrete")
fitER #view ASR model output
#round(fitER$lik.anc,3) #view marginal ancestral states

#### Phylogeny with absolute eye diameters (bars scaled by eye dimeter using phytools) and ancestral state estimation for activity pattern at nodes ####

#colors for plot
cols <- col_hab

#plot tree with eye size bars ant tip labels
plotTree.wBars(tree_edmass, aveye, 
               scale = 0.04, 
               tip.labels = TRUE, 
               offset = 0.4,
               ftype = "bi",
               fsize = 0.6,
               col = tipcols)

#label nodes with pie charts of ancestor state probabilities
nodelabels(node=1:tree_edmass$Nnode+Ntip(tree_edmass),
           pie = fitER$lik.anc, 
           piecol = cols,
           cex = 0.3)
tiplabels(pch = 21, col = "black", bg = tipcols, cex = 1, offset = 0.02)

#add legend for habitat states
legend(x="left",legend = c("Aquatic", "Fossorial", "Ground-dwelling", "Scansorial", "Semiaquatic", "Subfossorial"), pch = 22, pt.cex= 2, pt.bg = col_hab, cex = 1, bty = "n",horiz = F)

dev.off()

#second part of figure (eye investment)
pdf(file = "../phylo-habitat2.pdf", height=20, width=8)
#add bars for eye investment (relative to mass)
plotTree.wBars(tree_edmass, inv.mass, 
               scale = 0.6, 
               tip.labels = FALSE, 
               col = tipcols,
               plot = FALSE)
dev.off()

```

```{r supp-activity, fig.height = 15, fig.width = 8}

# Phylogeny for activity pattern

#export pdf of phylogeny, habitat ASR, and absolute eye size
pdf(file = "../phylo-activity.pdf", height=20, width=8)

#make trait vector of activity pattern
act.edmass <-as.vector(edmass.bars$act) 

#make vector of colors corresponding to phylogeny tips
tipcols <- unname(col_act[act.edmass]) 

## estimate ancestral states for adult habitat under a ER model
fitER <- ace(act.edmass, tree_edmass, model="ER", type="discrete")
fitER #view ASR model output
#round(fitER$lik.anc,3) #view marginal ancestral states

#### Phylogeny with absolute eye diameters (bars scaled by eye dimeter using phytools) and ancestral state estimation for activity pattern at nodes ####

#colors for plot
cols <- col_act

#plot tree with eye size bars ant tip labels
plotTree.wBars(tree_edmass, aveye, 
               scale = 0.04, 
               tip.labels = TRUE, 
               offset = 0.4,
               ftype = "bi",
               fsize = 0.6,
               col = tipcols)

#label nodes with pie charts of ancestor state probabilities
nodelabels(node=1:tree_edmass$Nnode+Ntip(tree_edmass),
           pie = fitER$lik.anc, 
           piecol = cols,
           cex = 0.3)
tiplabels(pch = 21, col = "black", bg = tipcols, cex = 1, offset = 0.02)

#add legend for habitat states
legend(x="left",legend = c("Both", "Diurnal", "Nocturnal"), pch = 22, pt.cex= 2, pt.bg = col_act, cex = 1, bty = "n",horiz = F)

dev.off()

#second part of figure (eye investment)
pdf(file = "../phylo-activity2.pdf", height=20, width=8)
#add bars for eye investment (relative to mass)
plotTree.wBars(tree_edmass, inv.mass, 
               scale = 0.6, 
               tip.labels = FALSE, 
               col = tipcols,
               plot = FALSE)
dev.off()

```

```{r supp-mating, fig.height = 15, fig.width = 8}

# Phylogeny for activity pattern

#export pdf of phylogeny, habitat ASR, and absolute eye size
pdf(file = "../phylo-mating.pdf", height=20, width=8)

#make trait vector of activity pattern
mat.edmass <-as.vector(edmass.bars$mat) 

#make vector of colors corresponding to phylogeny tips
tipcols <- unname(col_mat[mat.edmass]) 

## estimate ancestral states for adult habitat under a ER model
fitER <- ace(mat.edmass, tree_edmass, model="ER", type="discrete")
fitER #view ASR model output
#round(fitER$lik.anc,3) #view marginal ancestral states

#### Phylogeny with absolute eye diameters (bars scaled by eye dimeter using phytools) and ancestral state estimation for activity pattern at nodes ####

#colors for plot
cols <- col_mat

#plot tree with eye size bars ant tip labels
plotTree.wBars(tree_edmass, aveye, 
               scale = 0.04, 
               tip.labels = TRUE, 
               offset = 0.4,
               ftype = "bi",
               fsize = 0.6,
               col = tipcols)

#label nodes with pie charts of ancestor state probabilities
nodelabels(node=1:tree_edmass$Nnode+Ntip(tree_edmass),
           pie = fitER$lik.anc, 
           piecol = cols,
           cex = 0.3)
tiplabels(pch = 21, col = "black", bg = tipcols, cex = 1, offset = 0.02)

#add legend for habitat states
legend(x="left",legend = c("Ground", "Lentic water", "Lotic water", "Plants"), pch = 22, pt.cex= 2, pt.bg = col_mat, cex = 1, bty = "n",horiz = F)

dev.off()

#second part of figure (eye investment)
pdf(file = "../phylo-mating2.pdf", height=20, width=8)
#add bars for eye investment (relative to mass)
plotTree.wBars(tree_edmass, inv.mass, 
               scale = 0.6, 
               tip.labels = FALSE, 
               col = tipcols,
               plot = FALSE)
dev.off()

```

```{r supp-dich, fig.height = 15, fig.width = 8}

# Phylogeny for activity pattern

#export pdf of phylogeny, habitat ASR, and absolute eye size
pdf(file = "../phylo-dich.pdf", height=20, width=8)

#make trait vector of activity pattern
dich.edmass <-as.vector(edmass.bars$dich) 

#make vector of colors corresponding to phylogeny tips
tipcols <- unname(col_dich[dich.edmass]) 

## estimate ancestral states for adult habitat under a ER model
fitER <- ace(dich.edmass, tree_edmass, model="ER", type="discrete")
fitER #view ASR model output
#round(fitER$lik.anc,3) #view marginal ancestral states

#### Phylogeny with absolute eye diameters (bars scaled by eye dimeter using phytools) and ancestral state estimation for activity pattern at nodes ####

#colors for plot
cols <- col_dich

#plot tree with eye size bars ant tip labels
plotTree.wBars(tree_edmass, aveye, 
               scale = 0.04, 
               tip.labels = TRUE, 
               offset = 0.4,
               ftype = "bi",
               fsize = 0.6,
               col = tipcols)

#label nodes with pie charts of ancestor state probabilities
nodelabels(node=1:tree_edmass$Nnode+Ntip(tree_edmass),
           pie = fitER$lik.anc, 
           piecol = cols,
           cex = 0.3)
tiplabels(pch = 21, col = "black", bg = tipcols, cex = 1, offset = 0.02)

#add legend for habitat states
legend(x="left",legend = c("Absent", "Present"), pch = 22, pt.cex= 2, pt.bg = col_dich, cex = 1, bty = "n",horiz = F)

dev.off()

#second part of figure (eye investment)
pdf(file = "../phylo-dich2.pdf", height=20, width=8)
#add bars for eye investment (relative to mass)
plotTree.wBars(tree_edmass, inv.mass, 
               scale = 0.6, 
               tip.labels = FALSE, 
               col = tipcols,
               plot = FALSE)
dev.off()

```

```{r supp-lif, fig.height = 15, fig.width = 8}

# Phylogeny for life history

#export pdf of phylogeny, habitat ASR, and absolute eye size
pdf(file = "../phylo-lifehis.pdf", height=20, width=8)

#make trait vector of activity pattern
life.edmass <-as.vector(edmass.bars$lif) 

#make vector of colors corresponding to phylogeny tips
tipcols <- unname(col_lif[life.edmass]) 

## estimate ancestral states for adult habitat under a ER model
fitER <- ace(life.edmass, tree_edmass, model="ER", type="discrete")
fitER #view ASR model output
#round(fitER$lik.anc,3) #view marginal ancestral states

#### Phylogeny with absolute eye diameters (bars scaled by eye dimeter using phytools) and ancestral state estimation for activity pattern at nodes ####

#colors for plot
cols <- col_lif

#plot tree with eye size bars ant tip labels
plotTree.wBars(tree_edmass, aveye, 
               scale = 0.04, 
               tip.labels = TRUE, 
               offset = 0.4,
               ftype = "bi",
               fsize = 0.6,
               col = tipcols)

#label nodes with pie charts of ancestor state probabilities
nodelabels(node=1:tree_edmass$Nnode+Ntip(tree_edmass),
           pie = fitER$lik.anc, 
           piecol = cols,
           cex = 0.3)
tiplabels(pch = 21, col = "black", bg = tipcols, cex = 1, offset = 0.02)

#add legend for habitat states
legend(x="left",legend = c("Free-living larvae", "No free-living larvae"), pch = 22, pt.cex= 2, pt.bg = col_lif, cex = 1, bty = "n",horiz = F)

dev.off()

#second part of figure (eye investment)
pdf(file = "../phylo-lifehis2.pdf", height=20, width=8)
#add bars for eye investment (relative to mass)
plotTree.wBars(tree_edmass, inv.mass, 
               scale = 0.6, 
               tip.labels = FALSE, 
               col = tipcols,
               plot = FALSE)
dev.off()

```

```{r supp-larv, fig.height = 15, fig.width = 8}

# Phylogeny for larval habitat

#export pdf of phylogeny, habitat ASR, and absolute eye size
pdf(file = "../phylo-larvhab.pdf", height=20, width=8)

#make trait vector of activity pattern
larv.edmass <-as.vector(edmass.bars$larv) 

#make vector of colors corresponding to phylogeny tips
tipcols <- unname(col_larv[larv.edmass]) 

## estimate ancestral states for adult habitat under a ER model
fitER <- ace(larv.edmass, tree_edmass, model="ER", type="discrete")
fitER #view ASR model output
#round(fitER$lik.anc,3) #view marginal ancestral states

#### Phylogeny with absolute eye diameters (bars scaled by eye dimeter using phytools) and ancestral state estimation for activity pattern at nodes ####

#colors for plot
cols <- col_larv

#plot tree with eye size bars ant tip labels
plotTree.wBars(tree_edmass, aveye, 
               scale = 0.04, 
               tip.labels = TRUE, 
               offset = 0.4,
               ftype = "bi",
               fsize = 0.6,
               col = tipcols)

#label nodes with pie charts of ancestor state probabilities
nodelabels(node=1:tree_edmass$Nnode+Ntip(tree_edmass),
           pie = fitER$lik.anc, 
           piecol = cols,
           cex = 0.3)
tiplabels(pch = 21, col = "black", bg = tipcols, cex = 1, offset = 0.02)

#add legend for habitat states
legend(x="left",legend = c("Lentic water", "Lotic water", "No larvae", "Obscured", "Terrestrial"), pch = 22, pt.cex= 2, pt.bg = col_larv, cex = 1, bty = "n",horiz = F)

dev.off()

#second part of figure (eye investment)
pdf(file = "../phylo-larvhab2.pdf", height=20, width=8)
#add bars for eye investment (relative to mass)
plotTree.wBars(tree_edmass, inv.mass, 
               scale = 0.6, 
               tip.labels = FALSE, 
               col = tipcols,
               plot = FALSE)
dev.off()

```


## Eye size and investment by ecological variables 

We compared the distribution of absolute and relative eye sizes across states for each of the ecological traits we examined. 

```{r trait-stats-dataframe}

#Combine results from assessments of eye v. mass, eye v. svl, and cornea v. eye for stats (get all the pgls residuals from the various comparisons into the same dataframe)

edmass.sub <- av.edmass.phy %>%
  select(mod_tiplabel, eye_av, pglsres.edmass)

edsvl.sub <- av.edsvl.phy %>%
  select(mod_tiplabel, eye_av, pglsres.edsvl)

edcd.sub <- av.edcd.phy %>%
  select(mod_tiplabel, cornea_av, pglsres.edcd)

#merge subset dataframes with dplyr
all.res <- edmass.sub %>%
  full_join(edsvl.sub, by = "mod_tiplabel") %>%
  full_join(edcd.sub, by = "mod_tiplabel")

#add traits to dataframe
all.res.traits <- all.res %>%
  left_join(traits, by = "mod_tiplabel")
all.res.traits <- rename(all.res.traits, "eye_av" = "eye_av.x")
```

We made boxplots to show how eye size and investment varied across states for each ecological trait. 

```{r trait-boxplots}

#### Boxplots of absolute eye diameter by trait states ####

#create color vectors for states

#create vector of colors for activity period
col_act <- c("Both" = "deeppink3",
             "Diurnal" = "darkgoldenrod1", 
             "Nocturnal" = "blueviolet",
             "Unknown" = "gray")

# create vector of colors for life history
col_mat <- c("Ground" = "wheat4", 
         "Lentic water" = "royalblue1", 
         "Lotic water" = "skyblue1",
         "Plants" = "springgreen3",
         "Unknown" = "gray")


# create vector of colors for life history
col_lif <- c("Free-living larvae" = "darkturquoise", 
         "No free-living larvae" = "black", 
         "Unknown" = "gray")

# create vector of colors for larval habitat
col_larv <- c("Lentic water" = "royalblue1", 
         "Lotic water" = "skyblue1",
         "No larvae" = "lightcoral",
         "Obscured" = "darkslateblue",
         "On land" = "lightpink4",
         "Unknown" = "gray")

# create vector of colors for sex dichromatism
col_dich <- c("Absent" = "black", 
         "Present" = "chartreuse2",
         "Unknown" = "gray")

#boxplot of eye size by adult habitat
hab.abs <- ggplot(data = filter(all.res.traits, Adult_habitat != "Unknown" & !is.na(eye_av)), 
                  aes(x = reorder(Adult_habitat, eye_av, FUN=mean), 
                      y = eye_av)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Adult_habitat, text = genus_species), shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  scale_color_manual(values = col_hab) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_x_discrete(breaks=c("Aquatic","Semiaquatic","Fossorial", "Subfossorial", "Ground-dwelling", "Scansorial"),labels=c("Aq.", "Semiaq.", "Foss.", "Subfoss.", "Ground", "Scans.")) +
  ylab("Eye diameter (mm)") +
  xlab("Adult habitat") +
  theme(legend.position = "none")

#boxplot of eye size by activity period
acper.abs <- ggplot(data = filter(all.res.traits, Activity_period != "Unknown" & !is.na(eye_av)), aes(x = reorder(Activity_period, eye_av, FUN=mean), y = eye_av)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Activity_period, text = genus_species), shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_act) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  ylab("Eye diameter (mm)") +
  xlab("Activity period") +
  theme(legend.position = "none")

#boxplot of eye size by mating habitat
mating.abs <- ggplot(data = filter(all.res.traits, Mating_habitat != "Unknown" & !is.na(eye_av)), 
                aes(x = reorder(Mating_habitat, eye_av, FUN=mean), y = eye_av)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  scale_color_manual(values = col_mat) +
  geom_jitter(aes(color = Mating_habitat, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  ylab("Mean eye diameter (mm)") +
  xlab("Mating habitat") +
  theme(legend.position = "none")

#boxplot of eye size by life history
life.abs <- ggplot(data = filter(all.res.traits, Life_history != "Unknown" & !is.na(eye_av)), 
                aes(x = reorder(Life_history, eye_av, FUN=mean), y = eye_av)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Life_history, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_lif) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  ylab("Mean eye diameter (mm)") +
  xlab("Life history") +
  theme(legend.position = "none")

#boxplot of eye size by larval habitat
larval.abs <- ggplot(data = filter(all.res.traits, Larval_habitat != "Unknown" & !is.na(eye_av)), 
                aes(x = reorder(Larval_habitat, eye_av, FUN=mean), y = eye_av)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Larval_habitat, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_larv) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  ylab("Mean eye diameter (mm)") +
  xlab("Larval habitat") +
  theme(legend.position = "none")

#boxplot of eye size by sexual dichromatism
dichrom.abs <- ggplot(data = filter(all.res.traits, Sex_dichromatism != "Unknown" & !is.na(eye_av)), 
                aes(x = reorder(Sex_dichromatism, eye_av, FUN=mean), y = eye_av)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Sex_dichromatism, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_dich) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  ylab("Mean eye diameter (mm)") +
  xlab("Sex dichromatism") +
  theme(legend.position = "none")


#### Boxplots of relative eye size (by mass) by trait states ####

#boxplot of eye investment (residuals of eye diameter v. cube root of mass PGLS) by adult habitat
hab.res.mass <- ggplot(data = filter(all.res.traits, Adult_habitat != "Unknown" & !is.na(pglsres.edmass)), 
              aes(x = reorder(Adult_habitat, pglsres.edmass, FUN = mean), y = pglsres.edmass)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Adult_habitat, text = genus_species), shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  scale_color_manual(values = col_hab, name = "Adult habitat") +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text = element_text(angle = 0, size = 9)) +
 scale_x_discrete(breaks=c("Aquatic", "Fossorial", "Subfossorial", "Ground-dwelling", "Scansorial", "Semiaquatic"), labels=c("Aq.", "Foss.", "Subfoss.","Ground", "Scans.", "Semiaq.")) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by mass") +
  xlab("Adult habitat") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. cube root of mass PGLS) by activity period
acper.res.mass <- ggplot(data = filter(all.res.traits, Activity_period != "Unknown" & !is.na(pglsres.edmass)), 
                aes(x = reorder(Activity_period, pglsres.edmass, FUN=mean), y = pglsres.edmass)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Activity_period, text = genus_species), shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_act) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by mass") +
  xlab("Activity period") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. cube root of mass PGLS) by mating habitat
mating.res.mass <- ggplot(data = filter(all.res.traits, Mating_habitat != "Unknown" & !is.na(pglsres.edmass)), 
                aes(x = reorder(Mating_habitat, pglsres.edmass, FUN=mean), y = pglsres.edmass)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  scale_color_manual(values = col_mat) +
  geom_jitter(aes(color = Mating_habitat, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by mass") +
  xlab("Mating habitat") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. cube root of mass PGLS) by life history
life.res.mass <- ggplot(data = filter(all.res.traits, Life_history != "Unknown" & !is.na(pglsres.edmass)), 
                aes(x = reorder(Life_history, pglsres.edmass, FUN=mean), y = pglsres.edmass)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) + 
  geom_jitter(aes(color = Life_history, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_lif) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by mass") +
  xlab("Life history") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. cube root of mass PGLS) by larval habitat
larval.res.mass <- ggplot(data = filter(all.res.traits, Larval_habitat != "Unknown" & !is.na(pglsres.edmass)), 
                aes(x = reorder(Larval_habitat, pglsres.edmass, FUN=mean), y = pglsres.edmass)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Larval_habitat, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_larv) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by mass") +
  xlab("Larval habitat") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. cube root of mass PGLS) by sexual dichromatism
dichrom.res.mass <- ggplot(data = filter(all.res.traits, Sex_dichromatism != "Unknown" & !is.na(pglsres.edmass)), 
                aes(x = reorder(Sex_dichromatism, pglsres.edmass, FUN=mean), y = pglsres.edmass)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Sex_dichromatism, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_dich) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by mass") +
  xlab("Sex dichromatism") +
  theme(legend.position = "none")


#### Boxplots of relative eye size (by SVL) by trait states ####

#boxplot of eye investment (residuals of eye diameter v. SVL PGLS) by adult habitat
hab.res.svl <- ggplot(data = filter(all.res.traits, Adult_habitat != "Unknown" & !is.na(pglsres.edsvl)), 
              aes(x = reorder(Adult_habitat, pglsres.edsvl, FUN=mean), y = pglsres.edsvl)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Adult_habitat, text = genus_species), shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_hab, name = "Adult habitat") +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text = element_text(angle = 0, size = 9)) +
 scale_x_discrete(breaks=c("Aquatic","Semiaquatic","Fossorial", "Subfossorial", "Ground-dwelling", "Scansorial"), labels=c("Aq.", "Semiaq.", "Foss.", "Subfoss.", "Ground", "Scans.")) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by SVL") +
  xlab("Adult habitat") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. SVL PGLS) by activity period
acper.res.svl <- ggplot(data = filter(all.res.traits, Activity_period != "Unknown" & !is.na(pglsres.edsvl)), 
                aes(x = reorder(Activity_period, pglsres.edsvl, FUN=mean), y = pglsres.edsvl)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Activity_period, text = genus_species), shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_act) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by SVL") +
  xlab("Activity period") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. SVL PGLS) by mating habitat
mating.res.svl <- ggplot(data = filter(all.res.traits, Mating_habitat != "Unknown" & !is.na(pglsres.edsvl)), 
                aes(x = reorder(Mating_habitat, pglsres.edsvl, FUN=mean), y = pglsres.edsvl)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  scale_color_manual(values = col_mat) +
  geom_jitter(aes(color = Mating_habitat, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by SVL") +
  xlab("Mating habitat") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. SVL PGLS) by life history
life.res.svl <- ggplot(data = filter(all.res.traits, Life_history != "Unknown" & !is.na(pglsres.edsvl)), 
                aes(x = reorder(Life_history, pglsres.edsvl, FUN=mean), y = pglsres.edsvl)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) + 
  geom_jitter(aes(color = Life_history, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_lif) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by SVL") +
  xlab("Life history") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. SVL PGLS) by larval habitat
larval.res.svl <- ggplot(data = filter(all.res.traits, Larval_habitat != "Unknown" & !is.na(pglsres.edsvl)), 
                aes(x = reorder(Larval_habitat, pglsres.edsvl, FUN=mean), y = pglsres.edsvl)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Larval_habitat, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_larv) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by SVL") +
  xlab("Larval habitat") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. SVL PGLS) by sexual dichromatism
dichrom.res.svl <- ggplot(data = filter(all.res.traits, Sex_dichromatism != "Unknown" & !is.na(pglsres.edsvl)), 
                aes(x = reorder(Sex_dichromatism, pglsres.edsvl, FUN=mean), y = pglsres.edsvl)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Sex_dichromatism, text = genus_species), 
              shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_dich) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  ylab("Eye investment by SVL") +
  xlab("Sex dichromatism") +
  theme(legend.position = "none")

#### Boxplots of relative corneal size (to eye size) by trait states ####

#boxplot of corneal investment (residuals of cornea diameter v. eye diameter PGLS) by adult habitat
hab.res.cor <- ggplot(data = filter(all.res.traits, Adult_habitat != "Unknown" & !is.na(pglsres.edcd)), 
              aes(x = reorder(Adult_habitat, pglsres.edcd, FUN = mean), y = pglsres.edcd)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Adult_habitat, text = genus_species), shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_hab, name = "Adult habitat") +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text = element_text(angle = 0, size = 9)) +
 scale_x_discrete(breaks=c("Aquatic", "Fossorial", "Subfossorial", "Ground-dwelling", "Scansorial", "Semiaquatic"), labels=c("Aq.", "Foss.", "Subfoss.","Ground", "Scans.", "Semiaq.")) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0.0, 0.1, 0.2),
                     labels = c("0.6x","0.8x", "1x", "1.3x","1.6x")) +
  ylab("Corneal investment") +
  xlab("Adult habitat") +
  theme(legend.position = "none")

#boxplot of corneal investment (residuals of cornea diameter v. eye diameter PGLS) by activity period
acper.res.cor <- ggplot(data = filter(all.res.traits, Activity_period != "Unknown" & !is.na(pglsres.edcd)), 
                aes(x = reorder(Activity_period, pglsres.edcd, FUN=mean), y = pglsres.edcd)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Activity_period, text = genus_species), shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_act) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0.0, 0.1, 0.2),
                     labels = c("0.6x","0.8x", "1x", "1.3x","1.6x")) +
  ylab("Corneal investment") +
  xlab("Activity period") +
  theme(legend.position = "none")

#boxplot of corneal investment (residuals of cornea diameter v. eye diameter PGLS) by mating habitat
mating.res.cor <- ggplot(data = filter(all.res.traits, Mating_habitat != "Unknown" & !is.na(pglsres.edcd)), 
                aes(x = reorder(Mating_habitat, pglsres.edcd, FUN=mean), y = pglsres.edcd)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Mating_habitat, text = genus_species), shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_mat) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0.0, 0.1, 0.2),
                     labels = c("0.6x","0.8x", "1x", "1.3x","1.6x")) +
  ylab("Corneal investment") +
  xlab("Mating habitat") +
  theme(legend.position = "none")

#boxplot of corneal investment (residuals of cornea diameter v. eye diameter PGLS) by life history
life.res.cor <- ggplot(data = filter(all.res.traits, Life_history != "Unknown" & !is.na(pglsres.edcd)), 
                aes(x = reorder(Life_history, pglsres.edcd, FUN=mean), y = pglsres.edcd)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Life_history, text = genus_species), shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_lif) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0.0, 0.1, 0.2),
                     labels = c("0.6x","0.8x", "1x", "1.3x","1.6x")) +
  ylab("Corneal investment") +
  xlab("Life history") +
  theme(legend.position = "none")

#boxplot of corneal investment (residuals of cornea diameter v. eye diameter PGLS) by larval habitat
larval.res.cor <- ggplot(data = filter(all.res.traits, Larval_habitat != "Unknown" & !is.na(pglsres.edcd)), 
                aes(x = reorder(Larval_habitat, pglsres.edcd, FUN=mean), y = pglsres.edcd)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Larval_habitat, text = genus_species), shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_larv) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_y_continuous(breaks = c(-0.2, -0.1, 0.0, 0.1, 0.2),
                     labels = c("0.6x","0.8x", "1x", "1.3x","1.6x")) +
  ylab("Corneal investment") +
  xlab("Larval_habitat") +
  theme(legend.position = "none")

#boxplot of corneal investment (residuals of cornea diameter v. eye diameter PGLS) by sexual dichromatism
dichrom.res.cor <- ggplot(data = filter(all.res.traits, Sex_dichromatism != "Unknown" & !is.na(pglsres.edcd)), 
                aes(x = reorder(Sex_dichromatism, pglsres.edcd, FUN=mean), y = pglsres.edcd)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Sex_dichromatism, text = genus_species), shape = 19, size = 1.3, alpha = 0.3, position = position_jitter(0.15)) +
  scale_color_manual(values = col_dich) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
 scale_y_continuous(breaks = c(-0.2, -0.1, 0.0, 0.1, 0.2),
                     labels = c("0.6x","0.8x", "1x", "1.3x","1.6x")) +
  ylab("Corneal investment") +
  xlab("Sex dichromatism") +
  theme(legend.position = "none")
```

Then we plotted all of the absolute eye sizes and residuals from both mass and SVL to look for differences in distributions among ecological states. 

```{r interactive-boxplots, eval = FALSE}
print(ggplotly(hab.abs))
ggplotly(hab.res.mass)
ggplotly(hab.res.svl)
ggplotly(hab.res.cor)

ggplotly(acper.abs)
ggplotly(acper.res.mass)
ggplotly(acper.res.svl)
ggplotly(acper.res.cor)

ggplotly(mating.abs)
ggplotly(mating.res)
ggplotly(life.abs)
ggplotly(life.res)
ggplotly(larval.abs)
ggplotly(larval.res)
ggplotly(dichrom.abs)
ggplotly(dichrom.res)
ggplotly(size.abs)
ggplotly(size.res)
```

The boxplots for adult habitat also went into Figure 4, so we export those components here. 

```{r fig4-component2}

#export panels of eye scaling by habitat (SMA) and eye size by habitat, eye investment by habitat (boxplots) 

#make panels

fig.b <- hab.abs + 
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) +
  ylab("eye diameter (mm)") +
  xlab("habitat")

fig.c <- hab.res.mass +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) +
  ylab("eye investment") +
  xlab("habitat") +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x"))
  
fig.d <- plot_sma_habs.mass +
  theme(legend.position = "none", axis.title=element_text(size=12))
  
#use cowplot package to nicely plot the graphs together with a shared common legend.
bc <- plot_grid(fig.b, fig.c, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("B", "C"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of rows in grids

d <- plot_grid(fig.d, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("D"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of rows in grids

#export pdf of figure
pdf(file = "../Fig-4bcd.pdf", height=3, width=12)
plot_grid(bc, d, nrow = 1 ,rel_widths = c(1.4, 1))
dev.off()
```

We also construct figure 5 here. 

```{r fig5-boxplots}

#boxplots for mating habitat and sexual dichromatism

#make panels
fig.a <- ggplot(data = filter(all.res.traits, Mating_habitat != "Unknown" & !is.na(pglsres.edmass)), 
                aes(x = reorder(Mating_habitat, pglsres.edmass, FUN=mean), y = pglsres.edmass)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  geom_jitter(aes(color = Adult_habitat), shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  scale_color_manual(values = col_hab) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
  ylab("Eye investment") +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x")) +
  xlab("Mating habitat") +
  scale_x_discrete(breaks = c("Ground", "Lentic water","Lotic water","Plants"),
                  labels = c("Ground", "Lentic","Lotic","Plants")) +
  theme(legend.position = "none")

fig.b <- ggplot(data = filter(all.res.traits, Sex_dichromatism != "Unknown" & !is.na(pglsres.edmass)), 
                aes(x = reorder(Sex_dichromatism, pglsres.edmass, FUN=mean), y = pglsres.edmass)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  geom_jitter(aes(color = Adult_habitat, text = genus_species), shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  scale_color_manual(values = col_hab) +
  stat_summary(fun.y = mean, colour="black", geom="point", 
               shape=18, size=3, show_guide = FALSE) +
  theme(text = element_text(size=12), panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.text = element_text(angle = 0, size = 9), axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_blank(), axis.title.y = element_blank(),legend.position = "none") +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2)) +
  xlab("Sexual dichromatism")
  
#use cowplot package to nicely plot the graphs together with a shared common legend.
plots <- plot_grid(fig.a, fig.b, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("A","B"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           ncol = 2, #number of rows in grids
           rel_widths = c(1.6,1))

#export pdf of figure
pdf(file = "../Figure5-boxplots_alt.pdf", height=4, width=5.5)
plot_grid(plots)
dev.off()
```

We create boxplots for supplemental figures S4-9 here.

```{r suppfigs-traitboxplots}

#export boxplots by trait

#Adult habitat
#make panels
fig.b <- hab.abs + 
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank())

fig.c <- hab.res.mass +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 

fig.d <- hab.res.svl +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 

fig.e <- hab.res.cor +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
#use cowplot package to nicely plot the graphs together with a shared common legend.
bcde <- plot_grid(fig.b, fig.c, fig.d, fig.e, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("B", "C", "D", "E"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of rows in grids

#export pdf of figure
pdf(file = "../boxplot-habitats.pdf", height=3, width=12)
plot_grid(bcde)
dev.off()

#Activity pattern

#make panels
fig.b <- acper.abs + 
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank())

fig.c <- acper.res.mass +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
fig.d <- acper.res.svl +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
fig.e <- acper.res.cor +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
#use cowplot package to nicely plot the graphs together with a shared common legend.
bcde <- plot_grid(fig.b, fig.c, fig.d, fig.e, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("B", "C", "D", "E"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of rows in grids

#export pdf of figure
pdf(file = "../boxplot-acper.pdf", height=3, width=12)
plot_grid(bcde)
dev.off()

#Mating habitat

#make panels
fig.b <- mating.abs + 
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank())

fig.c <- mating.res.mass +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
fig.d <- mating.res.svl +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
fig.e <- mating.res.cor +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
#use cowplot package to nicely plot the graphs together with a shared common legend.
bcde <- plot_grid(fig.b, fig.c, fig.d, fig.e, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("B", "C", "D", "E"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of rows in grids

#export pdf of figure
pdf(file = "../boxplot-mating.pdf", height=3, width=12)
plot_grid(bcde)
dev.off()

#Sexual dichromatism

#make panels
fig.b <- dichrom.abs + 
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank())

fig.c <- dichrom.res.mass +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
fig.d <- dichrom.res.svl +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
fig.e <- dichrom.res.cor +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
#use cowplot package to nicely plot the graphs together with a shared common legend.
bcde <- plot_grid(fig.b, fig.c, fig.d, fig.e, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("B", "C", "D", "E"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of rows in grids

#export pdf of figure
pdf(file = "../boxplot-dichro.pdf", height=3, width=12)
plot_grid(bcde)
dev.off()

#Life History

#make panels
fig.b <- life.abs + 
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank())

fig.c <- life.res.mass +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
fig.d <- life.res.svl +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
fig.e <- life.res.cor +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
#use cowplot package to nicely plot the graphs together with a shared common legend.
bcde <- plot_grid(fig.b, fig.c, fig.d, fig.e, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("B", "C", "D", "E"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of rows in grids

#export pdf of figure
pdf(file = "../boxplot-lifehist.pdf", height=3, width=12)
plot_grid(bcde)
dev.off()

#Larval habitat

#make panels
fig.b <- larval.abs + 
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank())

fig.c <- larval.res.mass +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
fig.d <- larval.res.svl +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
fig.e <- larval.res.cor +
  theme(legend.position = "none", axis.title=element_text(size=12), axis.text.x=element_blank(), axis.ticks.x = element_blank()) 
#use cowplot package to nicely plot the graphs together with a shared common legend.
bcde <- plot_grid(fig.b, fig.c, fig.d, fig.e, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("B", "C", "D", "E"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of rows in grids

#export pdf of figure
pdf(file = "../boxplot-larvhab.pdf", height=3, width=12)
plot_grid(bcde)
dev.off()
```

### Statistical tests for differences in eye size and eye investment across ecological groups

Data for eye size and eye investment across ecological groups were not normally distributed, so we used non-parametric statistical tests for comparing our data between ecological groups. 

We used Kruskal-Wallis tests to test for differences in means across ecological groups, which is a non-parametric alternative to a one-way ANOVA test that uses ranks. It extends the two-sample Wilcoxon test to more than two groups. It’s recommended when the assumptions of one-way ANOVA test are not met, which was true across most of our data. As for the Wilcoxon test (or Mann-Whitney test) with two samples, this test converts the response values to ranks, and tests whether the ranks are distributed equally across the conditions, as would be expected under the null hypothesis.

When the Kruskal-Wallis test indicated that means differed across ecological groups and there were more than two groups, we used post-hoc Pairwise Wilcoxen Rank Sum Tests to caluclate pairwise comparisons between group levels with corrections for mulitple testing. This is a non-parametric alternative to a Tukey test that uses ranks to test for differences in means.

#### Adult habitat

```{r trait-stats-habitat}

#Habitat

# Dataframe with just habitat, eye size, residuals, with "Unknown" observations removed
hab.df <- all.res.traits %>% 
  select(mod_tiplabel, Adult_habitat, eye_av.y, pglsres.edmass, pglsres.edsvl, pglsres.edcd) %>% 
  rename(eye_av = eye_av.y) %>%
  mutate(Adult_habitat = as.factor(Adult_habitat)) %>%
  filter(Adult_habitat != "Unknown")

#Summary stats
hab.stats <- ddply(hab.df, ~Adult_habitat, summarise, 
                   mean.eye=mean(eye_av, na.rm = TRUE), 
                   sd.eye=sd(eye_av, na.rm = TRUE), 
                   n.eye=length(eye_av[!is.na(eye_av)]), 
                   mean.edmass=mean(pglsres.edmass, na.rm = TRUE),
                   sd.edmass=sd(pglsres.edmass, na.rm = TRUE),
                   n.edmass=length(pglsres.edmass[!is.na(pglsres.edmass)]), 
                   mean.edsvl=mean(pglsres.edsvl, na.rm = TRUE),
                   sd.edsvl=sd(pglsres.edsvl, na.rm = TRUE),
                   n.edsvl=length(pglsres.edsvl[!is.na(pglsres.edsvl)]),
                   mean.edcd=mean(pglsres.edcd, na.rm = TRUE),
                   sd.pglsres.edcd=sd(pglsres.edcd, na.rm = TRUE),
                   n.edcd=length(pglsres.edcd[!is.na(pglsres.edcd)]))

print(hab.stats)

# Test for differences in mean (absolute) eye size across habitat groups: Kruskal-Wallis test
kruskal.test(eye_av ~ Adult_habitat, data = hab.df) 

# Mulitple comparisons for differences in mean (absolute) eye size across habitat groups: Pairwise Wilcoxon rank sum tests
pairwise.wilcox.test(hab.df$eye_av, hab.df$Adult_habitat, p.adjust.method = "bonferroni")

# Test for differences relative eye size (by mass) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edmass ~ Adult_habitat, data = hab.df) 

# Mulitple comparisons for differences in eye investment (by mass) across habitat groups: Pairwise Wilcoxon rank sum tests
pairwise.wilcox.test(hab.df$pglsres.edmass, hab.df$Adult_habitat, p.adjust.method = "bonferroni")

# Test for differences in eye investment (by svl) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edsvl ~ Adult_habitat, data = hab.df) 

# Mulitple comparisons for differences in eye investment (by svl) across habitat groups: Pairwise Wilcoxon rank sum tests
pairwise.wilcox.test(hab.df$pglsres.edsvl, hab.df$Adult_habitat, p.adjust.method = "bonferroni")

# Test for differences in relative corneal size (compared to eye size) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edcd ~ Adult_habitat, data = hab.df) 

```

#### Activity period

```{r trait-stats-acper}

# Activity period

# Dataframe with just activity period, eye size, residuals, with "Unknown" observations removed
act.df <- all.res.traits %>% 
  select(mod_tiplabel, Activity_period, eye_av.y, pglsres.edmass, pglsres.edsvl, pglsres.edcd) %>% 
  rename(eye_av = eye_av.y) %>%
  mutate(Activity_period = as.factor(Activity_period)) %>%
  filter(Activity_period != "Unknown")

#Summary stats
act.stats <- ddply(act.df, ~Activity_period, summarise,
                   mean.eye=mean(eye_av, na.rm = TRUE), 
                   sd.eye=sd(eye_av, na.rm = TRUE), 
                   n.eye=length(eye_av[!is.na(eye_av)]), 
                   mean.edmass=mean(pglsres.edmass, na.rm = TRUE),
                   sd.edmass=sd(pglsres.edmass, na.rm = TRUE),
                   n.edmass=length(pglsres.edmass[!is.na(pglsres.edmass)]), 
                   mean.edsvl=mean(pglsres.edsvl, na.rm = TRUE),
                   sd.edsvl=sd(pglsres.edsvl, na.rm = TRUE),
                   n.edsvl=length(pglsres.edsvl[!is.na(pglsres.edsvl)]),
                   mean.edcd=mean(pglsres.edcd, na.rm = TRUE),
                   sd.pglsres.edcd=sd(pglsres.edcd, na.rm = TRUE),
                   n.edcd=length(pglsres.edcd[!is.na(pglsres.edcd)]))

print(act.stats)

# Test for differences in mean (absolute) eye size across activity period groups: Kruskal-Wallis test
kruskal.test(eye_av ~ Activity_period, data = act.df) 

# Mulitple comparisons for differences in mean (absolute) eye size across activity period groups: Pairwise Wilcoxon rank sum tests
pairwise.wilcox.test(act.df$eye_av, act.df$Activity_period, p.adjust.method = "bonferroni")

# Test for differences in eye investment (by mass) across activity period groups: Kruskal-Wallis test
kruskal.test(pglsres.edmass ~ Activity_period, data = act.df) 

# Test for differences in eye investment (by SVL) across activity period groups: Kruskal-Wallis test
kruskal.test(pglsres.edsvl ~ Activity_period, data = act.df) 

# Test for differences in relative corneal size (compared to eye size) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edcd ~ Activity_period, data = act.df) 

```

#### Mating habitat

```{r trait-stats-mating}

# Dataframe with just mating habitat, eye size, residuals, with "Unknown" observations removed
mat.df <- all.res.traits %>% 
  select(mod_tiplabel, Mating_habitat, eye_av.y, pglsres.edmass, pglsres.edsvl, pglsres.edcd) %>% 
  rename(eye_av = eye_av.y) %>%
  mutate(Mating_habitat = as.factor(Mating_habitat)) %>%
  filter(Mating_habitat != "Unknown")

#Summary stats
mat.stats <- ddply(mat.df, ~Mating_habitat, summarise,
                   mean.eye=mean(eye_av, na.rm = TRUE), 
                   sd.eye=sd(eye_av, na.rm = TRUE), 
                   n.eye=length(eye_av[!is.na(eye_av)]), 
                   mean.edmass=mean(pglsres.edmass, na.rm = TRUE),
                   sd.edmass=sd(pglsres.edmass, na.rm = TRUE),
                   n.edmass=length(pglsres.edmass[!is.na(pglsres.edmass)]), 
                   mean.edsvl=mean(pglsres.edsvl, na.rm = TRUE),
                   sd.edsvl=sd(pglsres.edsvl, na.rm = TRUE),
                   n.edsvl=length(pglsres.edsvl[!is.na(pglsres.edsvl)]),
                   mean.edcd=mean(pglsres.edcd, na.rm = TRUE),
                   sd.pglsres.edcd=sd(pglsres.edcd, na.rm = TRUE),
                   n.edcd=length(pglsres.edcd[!is.na(pglsres.edcd)]))

print(mat.stats)

# Test for differences in mean (absolute) eye size across mating habitat groups: Kruskal-Wallis test
kruskal.test(eye_av ~ Mating_habitat, data = mat.df) 

# Mulitple comparisons for differences in mean (absolute) eye size across mating habitat groups: Pairwise Wilcoxon rank sum tests
pairwise.wilcox.test(mat.df$eye_av, mat.df$Mating_habitat, p.adjust.method = "bonferroni")

# Test for differences in eye investment (by mass) across mating habitat: Kruskal-Wallis test
kruskal.test(pglsres.edmass ~ Mating_habitat, data = mat.df) 

# Mulitple comparisons for differences in eye investment (by mass) across mating habitat groups: Pairwise Wilcoxon rank sum tests
pairwise.wilcox.test(mat.df$pglsres.edmass, mat.df$Mating_habitat, p.adjust.method = "bonferroni")

# Test for differences in eye investment (by SVL) across mating habitat: Kruskal-Wallis test
kruskal.test(pglsres.edsvl ~ Mating_habitat, data = mat.df) 

# Mulitple comparisons for differences in eye investment (by SVL) across mating habitat groups: Pairwise Wilcoxon rank sum tests
pairwise.wilcox.test(mat.df$pglsres.edsvl, mat.df$Mating_habitat, p.adjust.method = "bonferroni")

# Test for differences in relative corneal size (compared to eye size) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edcd ~ Mating_habitat, data = mat.df) 
```

```{r mating-subset}

#subset to only ground-dwelling species and then test again. 

#Mating habitat
mat.ground <- all.res.traits %>% 
  filter(Adult_habitat == "Ground-dwelling") %>%
  select(mod_tiplabel, Mating_habitat, eye_av.y, pglsres.edmass, pglsres.edsvl, pglsres.edcd) %>% 
  rename(eye_av = eye_av.y) %>%
  mutate(Mating_habitat = as.factor(Mating_habitat)) %>%
  filter(Mating_habitat != "Unknown")

# Test for differences in eye investment (by mass) across mating habitat: Kruskal-Wallis test
kruskal.test(pglsres.edmass ~ Mating_habitat, data = mat.ground) 

#Summary stats (ground dwelling only)
mat.stats.ground <- ddply(mat.ground, ~Mating_habitat, summarise,
                   mean.eye=mean(eye_av, na.rm = TRUE), 
                   sd.eye=sd(eye_av, na.rm = TRUE), 
                   n.eye=length(eye_av[!is.na(eye_av)]), 
                   mean.edmass=mean(pglsres.edmass, na.rm = TRUE),
                   sd.edmass=sd(pglsres.edmass, na.rm = TRUE),
                   n.edmass=length(pglsres.edmass[!is.na(pglsres.edmass)]), 
                   mean.edsvl=mean(pglsres.edsvl, na.rm = TRUE),
                   sd.edsvl=sd(pglsres.edsvl, na.rm = TRUE),
                   n.edsvl=length(pglsres.edsvl[!is.na(pglsres.edsvl)]),
                   mean.edcd=mean(pglsres.edcd, na.rm = TRUE),
                   sd.pglsres.edcd=sd(pglsres.edcd, na.rm = TRUE),
                   n.edcd=length(pglsres.edcd[!is.na(pglsres.edcd)]))

print(mat.stats.ground)

```

#### Life history strategy

```{r trait-stats-lifehistory}

#Mating habitat

# Dataframe with just mating habitat, eye size, residuals, with "Unknown" observations removed
lif.df <- all.res.traits %>% 
  select(mod_tiplabel, Life_history, eye_av.y, pglsres.edmass, pglsres.edsvl, pglsres.edcd) %>% 
  rename(eye_av = eye_av.y) %>%
  mutate(Life_history = as.factor(Life_history)) %>%
  filter(Life_history != "Unknown")

#Summary stats
lif.stats <- ddply(lif.df, ~Life_history, summarise,
                   mean.eye=mean(eye_av, na.rm = TRUE), 
                   sd.eye=sd(eye_av, na.rm = TRUE), 
                   n.eye=length(eye_av[!is.na(eye_av)]), 
                   mean.edmass=mean(pglsres.edmass, na.rm = TRUE),
                   sd.edmass=sd(pglsres.edmass, na.rm = TRUE),
                   n.edmass=length(pglsres.edmass[!is.na(pglsres.edmass)]), 
                   mean.edsvl=mean(pglsres.edsvl, na.rm = TRUE),
                   sd.edsvl=sd(pglsres.edsvl, na.rm = TRUE),
                   n.edsvl=length(pglsres.edsvl[!is.na(pglsres.edsvl)]),
                   mean.edcd=mean(pglsres.edcd, na.rm = TRUE),
                   sd.pglsres.edcd=sd(pglsres.edcd, na.rm = TRUE),
                   n.edcd=length(pglsres.edcd[!is.na(pglsres.edcd)]))

print(lif.stats)

# Test for differences in mean (absolute) eye size across mating habitat groups: Kruskal-Wallis test
kruskal.test(eye_av ~ Life_history, data = lif.df) 

# Test for differences in eye investment (by mass) across mating habitat: Kruskal-Wallis test
kruskal.test(pglsres.edmass ~ Life_history, data = lif.df) 

# Test for differences in eye investment (by SVL) across mating habitat: Kruskal-Wallis test
kruskal.test(pglsres.edsvl ~ Life_history, data = lif.df) 

# Test for differences in relative corneal size (compared to eye size) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edcd ~ Life_history, data = lif.df)
```

#### Larval habitat

```{r trait-stats-larhab}

#Larval habitat

# Dataframe with just mating habitat, eye size, residuals, with "Unknown" observations removed
lar.df <- all.res.traits %>% 
  select(mod_tiplabel, Larval_habitat, eye_av.y, pglsres.edmass, pglsres.edsvl, pglsres.edcd) %>% 
  rename(eye_av = eye_av.y) %>%
  mutate(Larval_habitat = as.factor(Larval_habitat)) %>%
  filter(Larval_habitat != "Unknown")

#Summary stats
lar.stats <- ddply(lar.df, ~Larval_habitat, summarise,
                   mean.eye=mean(eye_av, na.rm = TRUE), 
                   sd.eye=sd(eye_av, na.rm = TRUE), 
                   n.eye=length(eye_av[!is.na(eye_av)]), 
                   mean.edmass=mean(pglsres.edmass, na.rm = TRUE),
                   sd.edmass=sd(pglsres.edmass, na.rm = TRUE),
                   n.edmass=length(pglsres.edmass[!is.na(pglsres.edmass)]), 
                   mean.edsvl=mean(pglsres.edsvl, na.rm = TRUE),
                   sd.edsvl=sd(pglsres.edsvl, na.rm = TRUE),
                   n.edsvl=length(pglsres.edsvl[!is.na(pglsres.edsvl)]),
                   mean.edcd=mean(pglsres.edcd, na.rm = TRUE),
                   sd.pglsres.edcd=sd(pglsres.edcd, na.rm = TRUE),
                   n.edcd=length(pglsres.edcd[!is.na(pglsres.edcd)]))

print(lar.stats)

# Test for differences in mean (absolute) eye size across mating habitat groups: Kruskal-Wallis test
kruskal.test(eye_av ~ Larval_habitat, data = lar.df) 

# Test for differences in eye investment (by mass) across mating habitat: Kruskal-Wallis test
kruskal.test(pglsres.edmass ~ Larval_habitat, data = lar.df) 

# Test for differences in eye investment (by SVL) across mating habitat: Kruskal-Wallis test
kruskal.test(pglsres.edsvl ~ Larval_habitat, data = lar.df) 

# Test for differences in relative corneal size (compared to eye size) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edcd ~ Larval_habitat, data = lar.df) 
```

#### Sexual dichromatism

```{r trait-stats-sexdichrom}

#Sexual dichromatism

# Dataframe with just sex dichromatism, eye size, residuals, with "Unknown" observations removed
dic.df <- all.res.traits %>% 
  select(mod_tiplabel, Sex_dichromatism, eye_av.y, pglsres.edmass, pglsres.edsvl, pglsres.edcd) %>% 
  rename(eye_av = eye_av.y) %>%
  mutate(Sex_dichromatism = as.factor(Sex_dichromatism)) %>%
  filter(Sex_dichromatism != "Unknown")

#Summary stats
dic.stats <- ddply(dic.df, ~Sex_dichromatism, summarise,
                   mean.eye=mean(eye_av, na.rm = TRUE), 
                   sd.eye=sd(eye_av, na.rm = TRUE), 
                   n.eye=length(eye_av[!is.na(eye_av)]), 
                   mean.edmass=mean(pglsres.edmass, na.rm = TRUE),
                   sd.edmass=sd(pglsres.edmass, na.rm = TRUE),
                   n.edmass=length(pglsres.edmass[!is.na(pglsres.edmass)]), 
                   mean.edsvl=mean(pglsres.edsvl, na.rm = TRUE),
                   sd.edsvl=sd(pglsres.edsvl, na.rm = TRUE),
                   n.edsvl=length(pglsres.edsvl[!is.na(pglsres.edsvl)]),
                   mean.edcd=mean(pglsres.edcd, na.rm = TRUE),
                   sd.pglsres.edcd=sd(pglsres.edcd, na.rm = TRUE),
                   n.edcd=length(pglsres.edcd[!is.na(pglsres.edcd)]))


print(dic.stats)

# Test for differences in mean (absolute) eye size across sex dichromatism habitat groups: Kruskal-Wallis test
kruskal.test(eye_av ~ Sex_dichromatism, data = dic.df) 

# Test for differences in eye investment (by mass) across mating habitat: Kruskal-Wallis test
kruskal.test(pglsres.edmass ~ Sex_dichromatism, data = dic.df)  

# Test for differences in eye investment (by SVL) across mating habitat: Kruskal-Wallis test
kruskal.test(pglsres.edsvl ~ Sex_dichromatism, data = dic.df) 

# Test for differences in relative corneal size (compared to eye size) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edcd ~ Sex_dichromatism, data = dic.df)  
```

### Adult habitat comparison based on Huang binary categories

```{r trait-stats-huanghab}

# Dataframe with just habitat, eye size, residuals, with "Unknown" observations removed
hab.huang <- all.res.traits %>% 
  select(mod_tiplabel, Adult_habitat, eye_av.y, pglsres.edmass, pglsres.edsvl, pglsres.edcd) %>% 
  rename(eye_av = eye_av.y) %>%
  mutate(Adult_habitat = as.factor(Adult_habitat)) %>%
  filter(Adult_habitat != "Unknown") %>%
  mutate(huang_habs = recode(Adult_habitat, 
         "Aquatic" = "A-S",
         "Semiaquatic"= "A-S",
         "Fossorial" = "T-A", 
         "Ground-dwelling" = "T-A",
         "Scansorial" = "T-A",
         "Subfossorial" = "T-A"))

#Summary stats
hh.stats <- ddply(hab.huang, ~huang_habs, summarise, 
                   mean.eye=mean(eye_av, na.rm = TRUE), 
                   sd.eye=sd(eye_av, na.rm = TRUE), 
                   n.eye=length(eye_av[!is.na(eye_av)]), 
                   mean.edmass=mean(pglsres.edmass, na.rm = TRUE),
                   sd.edmass=sd(pglsres.edmass, na.rm = TRUE),
                   n.edmass=length(pglsres.edmass[!is.na(pglsres.edmass)]), 
                   mean.edsvl=mean(pglsres.edsvl, na.rm = TRUE),
                   sd.edsvl=sd(pglsres.edsvl, na.rm = TRUE),
                   n.edsvl=length(pglsres.edsvl[!is.na(pglsres.edsvl)]),
                   mean.edcd=mean(pglsres.edcd, na.rm = TRUE),
                   sd.pglsres.edcd=sd(pglsres.edcd, na.rm = TRUE),
                   n.edcd=length(pglsres.edcd[!is.na(pglsres.edcd)]))

print(hh.stats)

# Test for differences in mean (absolute) eye size across habitat groups: Kruskal-Wallis test
kruskal.test(eye_av ~ huang_habs, data = hab.huang) 

# Test for differences relative eye size (by mass) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edmass ~ huang_habs, data = hab.huang) 
# Test for differences in eye investment (by svl) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edsvl ~ huang_habs, data = hab.huang) 

# Test for differences in relative corneal size (compared to eye size) across habitat groups: Kruskal-Wallis test
kruskal.test(pglsres.edcd ~ huang_habs, data = hab.huang) 

# Make boxplots of trait distributions. Categories by huang's habitat classifications but colored by ours. 

#boxplot of eye size by adult habitat
hh.abs <- ggplot(data = filter(hab.huang, !is.na(eye_av)), aes(x = huang_habs, y = eye_av)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Adult_habitat), shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  scale_color_manual(values = col_hab) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.text = element_text(angle = 0, size = 9)) +
    scale_x_discrete(breaks=c("A-S","T-A"),labels=c("Aq/S", "T/Ar")) +
  ylab("Eye diameter (mm)") +
  xlab("Binary habitat") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. cube root of mass PGLS) by huang habitat categories
hh.res.mass <- ggplot(data = filter(hab.huang, !is.na(pglsres.edmass)), aes(x = huang_habs, y = pglsres.edmass)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Adult_habitat), shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  scale_color_manual(values = col_hab, name = "Adult habitat") +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_x_discrete(breaks=c("A-S","T-A"),
                   labels=c("Aq/S", "T/Ar")) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2),
                     labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x"), limits = c(-0.62, 0.22)) +
  ylab("Eye investment by mass") +
  xlab("Binary habitat") +
  theme(legend.position = "none")

#boxplot of eye investment (residuals of eye diameter v. SVL PGLS) by adult habitat
hh.res.svl <-  ggplot(data = filter(hab.huang, !is.na(pglsres.edsvl)), aes(x = huang_habs, y = pglsres.edsvl)) +
  geom_boxplot(notch = FALSE, outlier.shape = NA) +
  stat_summary(fun.y = mean, colour="black", geom="point", shape=18, size=3, show_guide = FALSE) +
  geom_jitter(aes(color = Adult_habitat), shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  scale_color_manual(values = col_hab, name = "Adult habitat") +
    theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text = element_text(angle = 0, size = 9)) +
  scale_x_discrete(breaks=c("A-S","T-A"),
                   labels=c("Aq/S", "T/Ar")) +
  scale_y_continuous(breaks = c(-0.6, -0.4, -0.2, 0.0, 0.2), labels = c("0.25x", "0.40x", "0.6x", "1x", "1.6x"), limits = c(-0.62, 0.22)) +
  ylab("Eye investment by SVL") +
  xlab("Binary habitat") +
  theme(legend.position = "none")

#make figure for the supplemental information
fig.a <- hh.abs + 
  theme(legend.position = "none", axis.title=element_text(size=12))

fig.b <- hh.res.mass +
  theme(legend.position = "none", axis.title=element_text(size=12)) 
  
fig.c <- hh.res.svl +
  theme(legend.position = "none", axis.title=element_text(size=12)) 
  
#use cowplot package to nicely plot the graphs together with a shared common legend.
plots <- plot_grid(fig.a, fig.b, fig.c, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           labels = c("A", "B", "C"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 1) #number of rows in grids

# extract legends from figures
leg <- get_legend(hh.res.svl + theme_bw() + theme(legend.position = "right"))

#export pdf of figure
pdf(file = "../supp-huanghabs.pdf", height=3, width=10)
plot_grid(plots, leg, ncol = 2 ,rel_widths = c(1, 0.2))
dev.off()
```
